(()=>{"use strict";function t(){let t={};for(let s of arguments)s.walk((s=>{if(s.getUsedStats)for(let i of s.getUsedStats()){let s=e(i);s!=i&&(t[s]=(t[s]||0)+1),t[i]=(t[i]||0)+1}}));return Object.keys(t)}function e(t){return t.replace(/(_\d+)+$/,"")}class s{constructor(t,e){this.items=t||[],e&&Object.assign(this,e)}getType(){return"block"}hasItems(){return!0}compileChildrens(t){return this.items.filter((t=>!t.isBlank())).map((e=>e.compile(t)))}isBlank(){for(let t of this.items)if(!t.isBlank())return!1;return!0}isCollapsable(){return!0}isVariableSet(){return!1}isVariableGet(){return!1}process(t){return this}compile(t){return this.compileChildrens(t).join(";\n")}execute(e,s){return e.stats.ensure(t(this)),Function("stats","return "+this.compile(s))(e.stats)}getSignature(){return"("+(this.isCollapsable()?"":"!")+this.getType()+":"+this.items.map((t=>t.getSignature())).join(",")+")"}treeBlockFields(){return[this.items]}makeResult(){return this.noReturn?this:new i([this])}walk(t,e){for(let s of this.treeBlockFields()){for(let i of s)e&&e(i)||t(i);for(let i of s)e&&e(i)||i.walk&&i.walk(t,e)}}walkReplace(t){for(let e of this.treeBlockFields()){let s=[];for(let i of e){let e=t(i);e&&s.push(e)}e.splice(0,e.length,...s);for(let s of e)s.walkReplace&&s.walkReplace(t)}}getInfoProperties(){let t={};for(let e of Object.keys(this))"object"!=typeof this[e]&&(t[e]=this[e]);return t}}class i extends s{getType(){return"block_return"}appendChildren(){let t=this.items.pop();for(let t of arguments)this.items.push(t);t&&this.items.push(t)}compile(t){let e=this.items.map((e=>e.compile(t)));return e[e.length-1]="return "+e[e.length-1],e.join(";\n")}}class r{constructor(t){Object.assign(this,t)}getType(){return"item"}hasItems(){return!1}isVariableSet(){return!1}isVariableGet(){return!1}compile(t){return this.value||0}isBlank(){return this.static&&this.blank}process(t){return this}getSignature(){throw`Item ${this.constructor.name} has no "getSignature" method!`}}const n=["atk","hp","def"];class a{constructor(t){if(t)for(let e of Object.keys(t))this[e]=t[e]}add(t,e){this[t]=(this[t]||0)+e}set(t,e){this[t]=e}get(t){return this[t]||0}del(t){delete this[t]}isSet(t){return this.hasOwnProperty(t)}getTotal(t){let e=this.get(t+"_base"),s=this.get(t),i=this.get(t+"_percent");return i&&e&&(s+=e*(i/100)),e+s}getTotalPercent(t){return this.get(t+"_base")*(1+this.get(t+"_percent"))+this.get(t)}getBaseBonus(t){let e=this.get("base_dmg_bonus_"+t),s=this.get(t+"_base_atk_percent");return s&&(e+=this.getTotal("atk")*s/100),s=this.get(t+"_base_def_percent"),s&&(e+=this.getTotal("def")*s/100),s=this.get(t+"_base_hp_percent"),s&&(e+=this.getTotal("hp")*s/100),s=this.get(t+"_base_mastery_percent"),s&&(e+=this.getTotal("mastery")*s/100),e}isEmpty(){return 0==Object.keys(this).length}concat(t){for(let e of Object.keys(t))this[e]=(this[e]||0)+t[e]}getSetFunc(){let t=[];for(let e of Object.keys(this))t.push(`stats.${e} = ${this[e]}`);return Function("stats",t.join(";"))}getConcatFunc(t){let e=[];for(let t of Object.keys(this))e.push(`stats.${t} += ${this[t]}`);if(t)for(let s of Object.keys(t))e.push(`stats.${s} = ${t[s]}`);return Function("stats",e.join(";"))}truncate(t){for(let e of Object.keys(this))t.includes(e)||delete this[e]}ensure(t){for(let e of t)this[e]||=0}processPercent(){for(let t of Object.keys(this))o(t)&&(this[t]=this[t]/100)}revertPercent(){for(let t of Object.keys(this))o(t)&&(this[t]=100*this[t])}calcPost(){let t=this.calcTotals();if(this.post_atk_hp_bonus){let e=this.get("post_atk_hp_bonus")/100;this.add("atk",t.get("hp_total")*e)}}calcTotals(t){let e=new a;t||="";for(const s of["atk","def","hp"]){if(t&&t!=s)continue;let i=this.get(s+"_base"),r=i*this.get(s+"_percent")/100+this.get(s),n=i+r;e.add(s+"_base",i),e.add(s+"_bonus",r),e.add(s+"_total",n)}for(const s of["crit_rate","crit_dmg","mastery","healing","healing_recv","recharge","shield","recovery"]){if(t&&t!=s)continue;let i=this.get(s+"_base"),r=this.get(s),n=i+r;e.add(s+"_base",i),e.add(s+"_bonus",r),e.add(s+"_total",n)}for(const s of["anemo","geo","electro","pyro","cryo","hydro","phys"])for(const i of["dmg_","res_"]){if(t&&t!=i+s)continue;let r=this.get(i+s+"_base"),n=this.get(i+s),a=r+n;e.add(i+s+"_base",r),e.add(i+s+"_bonus",n),e.add(i+s+"_total",a)}return e}applyPostEffects(t,e,s){if(e&&e.length){let i={};for(const t of e){let e=t.getPriority();s&&e>s||(i[e]||(i[e]=[]),i[e].push(t))}for(let e of Object.keys(i).sort(((t,e)=>t-e))){let s=new a;for(const r of i[e]){let e=r.getData(this,t);s.concat(e)}this.concat(s)}}}getFormatted(t,e){return a.format(t,this.get(t),e)}revert(){let t=new a,e=Object.keys(this);for(let s=0;s<e.length;++s){const i=e[s];t.add(i,-1*this[i])}return t}static roundStatValue(t,e,s){let i=s||o(t||"");return e=parseFloat(e)+1e-8,i?e.toFixed(1):Math.round(e)}static format(t,e,s){s||={};let i=e,r=o(t);return Math.abs(e)<1e-5?s.zero?"0":"":(!function(t){if(o(t))return!0;if(t.match(/(_cooldown|_decimal)/))return!0;return!1}(t)?(i=Math.round(i),s.minimize&&(i>1e7?i=(i/1e6).toFixed(2)+"m":i>1e6&&(i=(i/1e6).toFixed(3)+"m"))):(i+=1e-8,i=i.toFixed(s.decimal_digits||1),s.no_decimal_zero&&(i=i.replace(/(\.\d*?)0+$/,"$1"),i=i.replace(/\.$/,"")),r&&(i+="%")),i=i.toString().replace(/\B(?=(\d{3})+(?!\d))/g," "),s.signed&&(e<0?"0"==i&&(i="-0"):i="+"+i),i)}static diff(t,e){let s=Object.assign({},t,e),i=new a;for(const r of Object.keys(s)){let s=e.get(r)-t.get(r);s&&i.add(r,s)}return i}}function o(t){return!!t.match(/_percent/)||!!t.match(/^(bond_of_life|stamina|recovery|duration|atk_speed|move_speed|healing|recharge|crit_|dmg_|enemy_|res_|.*bonus_|.*shield|.*_multi)/)}class l extends r{getType(){return"item_const"}getSignature(){return"(const:"+this.value+")"}}class h extends r{getType(){return"item_stat"}compile(t){return"stats."+this.stat}process(t){return t.staticStats&&t.staticStats.includes(this.stat)?new l({value:this.value,comment:this.stat}):super.process()}getUsedStats(){return[this.stat]}getSignature(){return"(stat:"+this.stat+")"}}class c extends h{getType(){return"item_stat_total"}getUsedStats(){return[this.stat,this.stat+"_base",this.stat+"_percent"]}process(t){return new m([new S([new h({stat:this.statBaseName(),value:this.baseBalue}),new y([new h({stat:this.statPercentName(),value:this.percentValue})],{comment:this.stat+"_percent",percent:!0})]),new h({stat:this.statFlatName(),value:this.flatValue})],{comment:this.stat}).process(t)}statBaseName(){return this.replaceName(this.stat+"_base")}statPercentName(){return this.replaceName(this.stat+"_percent")}statFlatName(){return this.replaceName(this.stat)}replaceName(t){return this.replace&&this.replace[t]?this.replace[t]:t}compile(t){return`(stats.${this.statBaseName()} * (1 + stats.${this.statPercentName()}) + stats.${this.statFlatName()})`}}class u extends r{constructor(t){t.name=t.ref.name,delete t.ref,super(t)}getType(){return"variable_get"}isVariableGet(){return!0}compile(t){return this.name}getSignature(){return"(var_value:"+this.name+")"}}function f(t,e){return t.indexOf("*")>0?function(t,e){if(!n.includes(t))return new m([f(t+"_base",e),f(t,e)],{comment:t,percent:o(t)});return new c({stat:t,value:e.getTotalPercent(t),baseBalue:e.get(t+"_base"),percentValue:e.get(t+"_percent"),flatValue:e.get(t)})}(t.replace("*",""),e):new h({stat:t,value:e.get(t)})}let g=BigInt(0);function p(t){return(t||"var")+"_"+ ++g}function d(t,e){let s=new u({ref:t}),i=new _([new w([new l({value:1}),new m([s,e])])]),r=new _([new w([new l({value:1}),new m([s,new S([new l({value:2}),e])])])]),n=new _([new w([new l({value:1}),new m([s,new S([new l({value:3}),e])])])]),a=new _([new w([new l({value:1}),new m([s,new S([new l({value:4}),e])])])]),o=new _([new w([new l({value:1}),new m([s,new S([new l({value:5}),e])])])]),h=new u({ref:i}),c=new u({ref:r}),f=new u({ref:n}),g=new u({ref:a}),p=new u({ref:o}),d=new v([new S([new l({value:-1}),p]),new m([s,h,c,f,g,new l({value:-1}),new S([new l({value:-1}),s,h]),new S([new l({value:-1}),s,c]),new S([s,h,c]),new S([new l({value:-1}),h,c]),new S([new l({value:-1}),s,f]),new S([s,h,f]),new S([new l({value:-1}),h,f]),new S([s,c,f]),new S([new l({value:-1}),s,h,c,f]),new S([h,c,f]),new S([new l({value:-1}),c,f]),new S([new l({value:-1}),s,g]),new S([s,h,g]),new S([new l({value:-1}),h,g]),new S([s,c,g]),new S([new l({value:-1}),s,h,c,g]),new S([h,c,g]),new S([new l({value:-1}),c,g]),new S([s,f,g]),new S([new l({value:-1}),s,h,f,g]),new S([h,f,g]),new S([new l({value:-1}),s,c,f,g]),new S([s,h,c,f,g]),new S([new l({value:-1}),h,c,f,g]),new S([c,f,g]),new S([new l({value:-1}),f,g]),new S([new l({value:4}),s,p]),new S([new l({value:-3}),s,h,p]),new S([new l({value:3}),h,p]),new S([new l({value:-2}),s,c,p]),new S([new l({value:2}),s,h,c,p]),new S([new l({value:-2}),h,c,p]),new S([new l({value:2}),c,p]),new S([new l({value:-1}),s,f,p]),new S([s,h,f,p]),new S([new l({value:-1}),h,f,p]),new S([s,c,f,p]),new S([new l({value:-1}),s,h,c,f,p]),new S([h,c,f,p]),new S([new l({value:-1}),c,f,p]),new S([f,p]),new S([new l({value:-5}),p])])]);return[[t,i,r,n,a,o],new _([d],{name:"crit_rate_avg"})]}class m extends s{getType(){return"block_sum"}dontShrink(){return 0}compile(t){let e=this.compileChildrens(t),s=e.join(" + ");return e.length>1&&(s="("+s+")"),s||"0"}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof l&&0!=t.value)),s=this.items.filter((t=>!(t instanceof l)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=0;for(let t of e)i+=t.value;let r=new l({value:i,comment:"processed"});if(0==s.length&&!this.dontShrink())return r;t.push(r);for(let e of s)t.push(e);this.items=t}else this.items=[...e,...s];return 0==this.items.length&&(this.items=[new l({value:0})]),super.process(t)}}class y extends m{getType(){return"block_sum_plus"}compile(t){let e=this.compileChildrens(t);return 0==e.length?"":(e.unshift(1),"("+e.join(" + ")+")")}process(t){return new m([new l({value:1}),...this.items.map((e=>e.process(t)))],this.getInfoProperties(t)).process(t)}}class b extends s{getType(){return"block_subtract"}compile(t){let e=this.compileChildrens(t),s=e.join(" - ");return e.length>1&&(s="("+s+")"),s||"0"}}class S extends s{getType(){return"block_multi"}compile(t){let e=this.compileChildrens(t),s=e.join(" * ");return e.length>1&&(s="("+s+")"),s||0}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof l&&1!=t.value)),s=this.items.filter((t=>!(t instanceof l)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=1;for(let t of e)i*=t.value;let r=new l({value:i,comment:"processed"});if(0==s.length)return r;t.push(r);for(let e of s)t.push(e);this.items=t}else this.items=[...e,...s];return 1==this.items.length&&"block_multi"==this.getType()?this.items[0]:super.process()}}class v extends s{getType(){return"block_divide"}compile(t){let e=this.compileChildrens(t),s=e.join(" / ");return e.length>1&&(s="("+s+")"),s||0}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof l)),s=this.items.filter((t=>!(t instanceof l)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=e.shift().value;for(let t of e)i/=t.value;let r=new l({value:i,comment:"processed"});if(0==s.length)return r;t.push(r);for(let e of s)t.push(e);this.items=t}return super.process()}}class w extends s{getType(){return"block_min"}compile(t){let e=this.compileChildrens(t);return e.length>1?"Math.min("+e.join(", ")+")":e[0]}}class _ extends m{getType(){return"variable_set"}isCollapsable(){return!1}isVariableSet(){return!0}constructor(t,e){(e=Object.assign({},e)).name=p(e.name),super(t,e)}compile(t){return"let "+this.name+" = "+super.compile(t)}}class C extends m{constructor(t,e){e.name=e.ref.name,delete e.ref,super(t,e)}getType(){return"variable_inc"}isCollapsable(){return!1}isVariableSet(){return!0}isVariableGet(){return!0}compile(t){return this.name+" += "+super.compile(t)}}class k extends s{getType(){return"post"}}class I extends s{getType(){return"isolated"}}class B extends m{getType(){return"stat_increase"}isCollapsable(){return!1}getAssignedStats(){return[this.stat]}compile(t){let e=super.compile(t);return this.newName?"stats."+this.newName+" = stats."+this.stat+" + "+e:"stats."+this.stat+" += "+e}}class j extends m{getType(){return"stat_decrease"}isCollapsable(){return!1}getAssignedStats(){return[this.stat]}compile(t){let e=super.compile(t);return"stats."+this.stat+" -= "+e}}class A{constructor(e,s){this.tree=e,this.postItems=s||[],this.usedStats=t(this.tree,...this.postItems),this.assignedStats=function(){let t={};for(let e of arguments){if(e.getAssignedStats)for(let s of e.getAssignedStats())t[s]=(t[s]||0)+1;e.walk((e=>{if(e.getAssignedStats)for(let s of e.getAssignedStats())t[s]=(t[s]||0)+1}))}return Object.keys(t)}(this.tree,...this.postItems),this.isReacted=!1}checkForReaction(){this.tree.walk((t=>{t.isReacted&&(this.isReacted=!0)}))}prepare(t,e){e=Object.assign({},e);let i,r="damage_rotation_result"==this.tree.getType(),n=this.tree.makeResult();if(r||(i=this.makePostTree(e)),this.processed=new s,e.dontProcessTree||(this.processBlock(n,e),i&&this.processBlock(i,e)),i&&this.processed.items.push(i),this.processed.items.push(n),i&&i.revert&&i.revert.length){let t=this.processed.items[this.processed.items.length-1];t.appendChildren?t.appendChildren(...i.revert):this.processed.items.push(...i.revert)}}processBlock(t,e){t.walkReplace((t=>t.process(e))),t.process(e),this.processVariables(t,e)}makePostTree(t){let e=[];for(let s of this.postItems)(t.dontProcessStats||s.stat&&this.usedStats.includes(s.stat))&&e.push(s);if(0==e.length)return;let[s,i]=A.postTreeBlocks(e,t);return new k(s,{revert:i})}static filterPostByStats(s,i){let r=[],n=D(s);i=[].concat(i);for(let s of Object.keys(n).sort().reverse())for(let a of n[s]){let s=e(a.stat);if(a.stat&&(i.includes(a.stat)||i.includes(s))){r.push(a);for(let e of t(a))i.includes(e)||i.push(e)}}return r}static postTreeBlocks(t){let e=[],s=[],i=D(t);for(let t of Object.keys(i).sort()){let r=[],n=[];for(let e of i[t]){let t=new _([e],{name:"post_"+e.stat});r.push(t),n.push(new B([new u({ref:t})],{stat:e.stat})),s.unshift(new j([new u({ref:t})],{stat:e.stat}))}e.push(new I([...r,...n]))}return[e,s]}getCode(t){return this.processed.compile(t)}compile(t){let e=this.getCode(t);return this.compiled=Function("stats",e),e}compilePostTree(t){let e=this.makePostTree(t);return e?(t.dontProcessTree||this.processBlock(e,t),Function("stats",e.compile(t))):Function("stats","")}execute(t){return this.compiled(t.stats)}processVariables(t,e){e.dontInsertVariables||t.walk((t=>{"isolated"==t.getType()&&this.replaceBlockRepeat(t)}))}replaceBlockRepeat(t){for(let e=0;e<10;++e){let e={};t.walk((t=>{if(t.hasItems()){let s=t.getSignature();s&&!s.includes("!")&&(e[s]=(e[s]||0)+1)}}),(t=>"isolated"==t.getType()));let s=[];for(let[t,i]of Object.entries(e))i<2||s.push(t);let i=[];for(let t of s){let e=!0;for(let i of s)if(t!=i&&i.indexOf(t)>=0){e=!1;break}e&&i.push(t)}if(0==i.length)break;let r={},n={};t.walkReplace((t=>{let e=t.getSignature();if(e&&i.includes(e)){if(!r[e]){let s=new _([t]);r[e]=s,n[s.name]=s}return new u({ref:r[e]})}return t})),t.items=z(t.items,n)}}}function z(t,e){let s=[];for(;Object.keys(e).length;){s=[];for(let i of t){let t={};i.walk((e=>{e.isVariableGet()&&!e.isVariableSet()&&(t[e.name]=1)}));for(let i of Object.keys(t))e[i]&&(s.push(e[i]),delete e[i]);s.push(i)}t=s}return s}function D(t){let e={};for(let s of t){let t=s.priority;e[t]||(e[t]=[]),e[t].push(s)}return e}const O=1;class T{constructor(t){Object.assign(this,t)}set(t,e){this[t]=e}get(t){return this[t]}getNumber(t){return this[t]||0}concat(){for(let t of arguments)Object.assign(this,t)}getLevel(t){return E(t,this)}}function E(t,e){let s=e[t]||1;s+=e[t+"_bonus"]||0,s+=e[t+"_bonus_2"]||0;let i=/\w+_(char_skill_\w+)/.exec(t);return i&&(s+=e[i[1]+"_bonus_party"]||0),s}class x{constructor(t,e){this.stats=new a(e),this.settings=new T(t),this.multipliers=[],this.postEffects=[]}addStats(t){this.stats.concat(t)}addSettings(t){this.settings.concat(t)}getActivePostEffects(){return this.postEffects.filter((t=>t.isActive(this.settings)))}getActivePostEffectsTree(){let t=this.getActivePostEffects(),e=[];for(let s of t)if(s.getTree)for(let t of s.getTree(this))e.push(t);return e}applyPostEffects(t){for(let t of this.postEffectTreeByPriority()){let e=new A(new s([]),t),i=e.compilePostTree({dontProcessStats:!0});i&&(this.stats.ensure(e.usedStats),this.stats.ensure(e.assignedStats),i(this.stats))}this.postEffects=[]}postEffectByPriority(t){t=Object.assign({},t);let e=this.getActivePostEffects(),s={};for(let i of e){let e=i.getPriority();t.maxPriority&&e>t.maxPriority||(s[e]||(s[e]=[]),s[e].push(i))}let i=[];for(let t of Object.keys(s).sort())i.push(s[t]);return i}postEffectTreeByPriority(t){let e=this.postEffectByPriority(t),s=[];for(let t of e){let e=[];for(let s of t)e=e.concat(s.getTree(this));s.push(e)}return s}getResistance(t){return this.settings.get("enemy_res_"+t)+100*this.stats.get("enemy_res_"+t)}clone(){let t=new x(this.settings,this.stats);return t.postEffects=[].concat(this.postEffects),t.multipliers=[].concat(this.multipliers),t}}class F{static pack(t){let e=t.serialize(),s="";if(e){for(const t of e)s+=L(t);return s}}static unpack(t){let e=t.split(""),s=[],i=0;for(;e.length>0;){let t=e.shift();"\0"==t&&(t="b");let r=t.toUpperCase().charCodeAt(0)-65;if(r<0&&r>25)return null;i+=r,t.toLowerCase()==t?(s.push(i),i=0):i*=26}return i&&s.push(i),s}}function L(t){let e=parseInt(t),s="";for(;e>25;){let t=e%26;e-=t,e/=26,s=String.fromCharCode(65+t)+s}s=String.fromCharCode(65+e)+s;let i=s.substring(s.length-1);return s.substring(0,s.length-1).toUpperCase()+i.toLowerCase()}function P(t,e,s){let i=DB.Artifacts.Substats.get(t),r=DB.Artifacts.Rarity[e-1],n=i.rolls[e-1],o="percent"==i.type,l=R([],s,n,r.maxUpgrades,o);l=function(t){let e={};for(let s of t){let t=s.pop();e[[].concat(s.sort(),[t]).join("-")]=1}let s=[];for(const t of Object.keys(e).sort())s.push(t.split("-"));return s}(l),l=l.sort((function(t,e){return t[t.length-1]-e[e.length-1]||t.length-e.length}));let h=l[0],c=[];h||(h=[0]);let u=a.roundStatValue("",h.pop(),o);for(let t of h){let e=1;for(let s=0;s<n.length;++s)t==n[s]&&(e=2+s);c.push({value:a.roundStatValue("",t,o),rarity:e})}return{steps:c,maxValue:c.length*n[n.length-1],last:u,maxUpgrades:r.maxUpgrades}}function R(t,e,s,i,r){let n=[];if(i<=0){let s=N(t,e,r),i=[].concat(t);return i.push(Math.abs(s)),[i]}for(let a of s){let o=[].concat(t);o.push(a);let l=N(o,e,r);l>0?n=n.concat(R(o,e,s,i-1,r)):(0==l?o.push(0):(o=[].concat(t),o.push(Math.abs(a+l))),n.push(o))}return n}function N(t,e,s){let i=t.reduce((function(t,e){return t+e}),0),r=a.roundStatValue("",e,s)-a.roundStatValue("",i,s);return Math.abs(r)<.001?0:e-i}class M{constructor(t,e,s,i,r,n){this.rarity=t,this.level=e,this.slot=s,this.set=i,this.mainStat=r,this.subStats=n||[],this.locked=!1,this.groups=[],this.calculated=null}addStat(t,e){this.subStats.push({stat:t,value:e}),this.calculated=null}calcStats(){const t=new a;let e=DB.Artifacts.Mainstats.get(this.mainStat);if(e){let s=e.values[this.rarity-1];t.add(this.mainStat,s.getValue(this.level))}for(let e=0;e<this.subStats.length;++e){let s=this.subStats[e],i=DB.Artifacts.Substats.get(s.stat);t.add(s.stat,i.getPreciseValue(s.value,this.rarity))}return t.add("crit_value",2*t.get("crit_rate")+t.get("crit_dmg")),t}calcCache(t){this.calculated=this.calcStats(),this.calculated.truncate(t),this.calculated.processPercent()}replace(t){this.rarity=t.rarity,this.level=t.level,this.slot=t.slot,this.set=t.set,this.mainStat=t.mainStat,this.subStats=t.subStats,this.groups=t.getGroups(),this.calculated=null}getLevel(){return this.level}getSet(){return this.set}getRarity(){return this.rarity}getMainStat(){return""+this.mainStat}getSetName(){return""+this.set}getSlot(){return""+this.slot}getMainStatValue(){let t=this.getMainStat();return t?DB.Artifacts.Mainstats.get(t).values[this.rarity-1].getValue(this.level):0}getSubStats(){return this.subStats}setGroups(t){let e=t;Array.isArray(t)||(e=[t]);let s=[];for(let t of e){let e=M.trimGroupName(t);M.inGroups(s,e)||s.push(e)}this.groups=s}getGroups(){return this.groups&&0!=this.groups.length?this.groups:[""]}hasGroup(t){let e=t.toUpperCase();for(let t of this.groups)if(e==t.toUpperCase())return!0;return!1}inGroups(t){for(let e of t)if(this.hasGroup(e))return!0;return!1}isValid(){return 0==this.getErrors().length}setLocked(t){this.locked=!!t}isLocked(){return this.locked}getHash(){return F.pack(this)}getErrors(){let t=[];DB.Artifacts.Sets.get(this.set)||t.push("no_set"),DB.Artifacts.Mainstats.get(this.mainStat)||t.push("no_main_stat");let e=DB.Artifacts.Rarity[this.rarity-1],s=this.subStats.length;(s<e.minSubstats||s>e.maxSubstats)&&t.push("substat_count_mismatch");let i=!1,r=!1,n=!1,a=!1,o=[],l=0;for(const t of this.subStats){t.stat==this.mainStat&&(i=!0),o.includes(t.stat)&&(a=!0),o.push(t.stat);let e=P(t.stat,this.rarity,t.value);e.last>0&&(e.steps.length<e.maxUpgrades?n=!0:r=!0),e.steps.length>1&&(l+=e.steps.length-1)}let h=e.maxSubstats-4+Math.floor(this.level/4),c=Math.max(0,e.minSubstats-4+Math.floor(this.level/4));return l>0&&this.subStats.length<4&&t.push("not_full_substats"),(l>h||l>=e.maxUpgrades)&&t.push("too_much_upgrades"),l<c-1&&t.push("too_low_upgrades"),i&&t.push("substat_equal_main"),n&&t.push("substat_value_rolls"),r&&t.push("substat_value_range"),a&&t.push("substat_duplicate"),t}getErrorsFormatted(){let t=this.getErrors();if(0==t.length)return"";let e="";for(const s of t)e+="<p>"+UI.Lang.get("artifact_error."+s)+"</p>";return e}toGood(){let t=DB.Artifacts.Sets.get(this.set),e=DB.Artifacts.Mainstats.get(this.mainStat),s={setKey:t.getGoodId(),slotKey:this.slot,level:this.level,rarity:this.rarity,mainStatKey:e.goodId,location:"",lock:!1,substats:[]};for(const t of this.subStats){let e=DB.Artifacts.Substats.get(t.stat);if(!e)return null;s.substats.push({key:e.goodId,value:t.value})}return s}serialize(){let t=[1];t.push(DB.Artifacts.Sets.getId(this.set)),t.push(this.rarity),t.push(this.level),t.push(DB.Artifacts.Slots.getId(this.slot)),t.push(DB.Artifacts.Mainstats.getId(this.mainStat)||0),t.push(this.subStats.length);for(const e of this.subStats){t.push(DB.Artifacts.Substats.getId(e.stat));let s=DB.Artifacts.Substats.get(e.stat),i=e.value;"percent"==s.type&&(i=Math.floor(10*i)),t.push(i)}return t}clone(){return M.deserialize(this.serialize())}static deserialize(t){let e=null;if(1==t.shift()){let s=DB.Artifacts.Sets.getKeyId(t.shift());if(!s)return null;let i=t.shift();if(i<1||i>5)return null;let r=t.shift();if(r<0||r>20)return null;let n=DB.Artifacts.Slots.getKeyId(t.shift());if(!n)return null;let a=DB.Artifacts.Mainstats.getKeyId(t.shift())||"",o=t.shift();if(o<0||o>4)return null;e=new M(i,r,n,s,a);for(let s=1;s<=o;++s){let s=DB.Artifacts.Substats.getKeyId(t.shift());if(!s)return null;let i=t.shift();if(i<1)return null;let r=DB.Artifacts.Substats.get(s);if(!r)return null;i="percent"==r.type?parseFloat(i)/10:parseInt(i),e.addStat(s,i)}}return e}static fromGood(t){let e=DB.Artifacts.Sets.getKeyIdGood(t.setKey),s=DB.Artifacts.Sets.get(e);if(!s)return null;if(!DB.Artifacts.Slots.get(t.slotKey))return null;let i=DB.Artifacts.Mainstats.getKeyIdGood(t.mainStatKey),r=DB.Artifacts.Mainstats.get(i);if(!r)return null;if(!r.slots.includes(t.slotKey))return null;if(t.rarity<s.minRarity&&t.rarity>s.maxRarity)return null;let n=DB.Artifacts.Rarity[t.rarity-1];if(t.level<0&&t.level>n.maxLevel)return null;let a=new M(t.rarity,t.level,t.slotKey,e,i);if(Array.isArray(t.substats)){if(t.substats.length>4)return null;for(const e of t.substats){if(!e.key)continue;let t=DB.Artifacts.Substats.getKeyIdGood(e.key);if(!t)return null;let s=e.value;a.addStat(t,s)}}return a}static subStatsIsSimilar(t,e){if(t.subStats.length<e.subStats.length)return!1;for(let s=0;s<e.subStats.length;++s)if(t.subStats[s].stat!=e.subStats[s].stat||t.subStats[s].value<e.subStats[s].value)return!1;return!0}static inGroups(t,e){for(let s of t)if(M.groupsAreEqual(s,e))return!0;return!1}static groupsAreEqual(t,e){return t.toUpperCase()==e.toUpperCase()}static trimGroupNames(t){Array.isArray(t)||(t=[t]);let e=[];for(let s of t)e.push(M.trimGroupName(s));return e}static trimGroupName(t){let e=t||"";return e=e.replace(/[^\w\u0400-\u04ff\d_\-\s]/g,""),e=e.replace(/\s+/g," "),e.trim()}static settingName(t){return"set_pieces."+t.toLowerCase()}static settingNameShort(t){return t.toLowerCase()}}class H{constructor(t){this.params=t||{},this.entityId=0}getId(){return this.params.serializeId||0}getEntityId(){return this.entityId}getName(){return this.params.name}getNamesList(){return[this.getName()]}getType(){return""}getTitle(t){return this.params.title?UI.Lang.getTalent(this.params.title,t):""}getIcon(){return this.params.icon?this.params.icon.name:""}getDescription(t){return this.params.description?UI.Lang.getTalent(this.params.description,t):""}getInfo(){return this.params.info}getLevel(t){return E(this.params.levelSetting,t)}isHidden(t){if(this.params.isHidden)return!0;let e=this.params.hideCondition;if(e)for(let s=0;s<e.length;++s){if(e[s].isActive(t))return!0}return!1}isActive(t){return this.checkSubconditions(t)}isSerializable(){let t=this.getName(),e=this.getType();return!(!t&&!e||"static"==e)}getMaxStacks(t){return this.params.maxStacks||0}checkSubconditions(t){if(this.params.condition)return this.params.condition.isActive(t);{let e=this.params.subConditions;if(e)for(let s=0;s<e.length;++s){if(!e[s].isActive(t))return!1}}return!0}getData(t){let e={settings:{}};return this.isActive(t)?(e.settings=this.params.settings||{},e.stats=this.getStats(t)):e.stats=new a,e}getStats(t){return new a(this.params.stats||{})}getBuffRotationSection(t){return this.params.rotation||""}static allConditionsOn(t,e){let s={};for(let i=0;i<t.length;++i){const r=t[i];let n=r.getType();"stacks"==n?s[r.getName()]=r.getMaxStacks():"checkbox"==n?s[r.getName()]=!0:"dropdown"==n?s[r.getName()]=r.params.suggesterValue||0:r.getAllConditionsOn&&Object.assign(s,r.getAllConditionsOn(e))}return s}static allConditionsOff(t){let e={};for(let s=0;s<t.length;++s){const i=t[s];let r=i.getType();"stacks"==r?e[i.getName()]=0:"checkbox"==r&&(e[i.getName()]=!1)}return e}static setCommonValues(t,e){let s={};for(let i=0;i<e.length;++i){const r=e[i].getName();/^common\./.test(r)&&(t[r]||=0,s[r]=t[r])}return s}static unwrap(t,e){let s=[];for(let i of t)if(i.getCondtitionList)for(let t of i.getCondtitionList())e&&!t.isActive(e)||s.push(t);else s.push(i);return s}}class V{constructor(){this.object=null,this.settings={}}getName(){return this.object&&this.object.getName()||""}getIcon(){return this.object&&this.object.getIcon()||""}getRarity(){return this.object&&this.object.getRarity()||1}set(t){this.object=t,this.removeInvalidSettings()}get(){return this.object}getConditions(){return this.object&&this.object.getConditions()||[]}getFeatures(){return this.object&&this.object.getFeatures()||[]}getPostEffects(){return this.object&&this.object.getPostEffects()||[]}getMultipliers(){return this.object&&this.object.getMultipliers()||[]}getSettings(){return Object.assign({},this.settings)}getLevels(){return this.levels}getStats(){const t=new a;if(this.object&&this.object.statTable)for(let e=0;e<this.object.statTable.length;++e){let s=this.object.statTable[e],i=s.getValue(this.levels.level,this.levels.ascension);t.add(s.getName(),i)}return{stats:t,settings:{}}}setSettings(t){this.settings=t}modifySettings(t){return Object.assign(this.settings,t),this.getSettings()}addSettings(t){this.settings=Object.assign(this.settings,t)}isBeta(){return this.object&&this.object.isBeta()}serialize(){return[]}removeInvalidSettings(){let t=this.getConditions(),e=H.allConditionsOn(t);for(const t of Object.keys(this.settings))void 0===e[t]&&delete this.settings[t]}serializeConditions(t,e){let s=0,i=[],r=[];if(e)for(const s of H.unwrap(e,t))s.isActive(t)&&r.push(s);else for(const e of H.unwrap(this.getConditions({serialize:!0}),t))e.isActive(t)&&r.push(e);for(const e of r){if(!e.params.serializeId)continue;let r=e.getType();if("checkbox"==r)++s,i.push(e.params.serializeId);else if("stacks"==r)++s,i.push(e.params.serializeId),i.push(t[e.getName()]);else if("number"==r){++s,i.push(e.params.serializeId);let r=t[e.getName()]||0;r="decimal"==e.params.format?Math.floor(10*parseFloat(r)):parseInt(r),i.push(Math.max(0,r))}else if("dropdown"==r||"dropdown_multiple"==r){let r=e.getSelectedId(t);r&&(++s,i.push(e.params.serializeId),i.push(r))}else if("char"==r){let r=this.serializeChars(t);r.length&&(++s,i.push(e.params.serializeId),i=i.concat(r))}else if("custom_buffs"==r){let r=this.serializeCustomBuffs(t);r.length&&(++s,i.push(e.params.serializeId),i=i.concat(r))}}return i.unshift(s),i}serializeChars(t){return[]}serializeCustomBuffs(t){return[]}deserializeChars(t){return{}}deserializeCustomBuffs(t){return{}}deserializeConditions(t,e){let s={},i=t.shift(),r={};if(e)for(const t of H.unwrap(e))t.params.serializeId&&(r[t.params.serializeId]=t);else for(const t of H.unwrap(this.getConditions({serialize:!0})))t.params.serializeId&&(r[t.params.serializeId]=t);for(let e=1;e<=i;++e){let i=t.shift();if(e<1)return;let n=r[i];if(!n)return;let a=n.getType();if("checkbox"==a)s[n.getName()]=!0;else if("stacks"==a){let e=t.shift();e>n.params.maxStack&&(e=n.params.maxStack),s[n.getName()]=e}else if("number"==a){let e=t.shift();"decimal"==n.params.format&&(e=(e/10).toFixed(1)),s[n.getName()]=e}else if("dropdown"==a||"dropdown_multiple"==a){let e=n.getValueById(t.shift());s[n.getName()]=e||""}else"char"==a?s=Object.assign(s,this.deserializeChars(t)):"custom_buffs"==a&&(s=Object.assign(s,this.deserializeCustomBuffs(t)))}return s}}const q=["flower","plume","sands","goblet","circlet"];class U extends V{constructor(){super(),this.artifacts={flower:null,plume:null,sands:null,goblet:null,circlet:null}}get(){return this.artifacts}hasEquipped(){for(let t of q)if(this.artifacts[t])return!0;return!1}getSettings(){let t=Object.assign({},this.settings),e={};for(let t of q){let s=this.artifacts[t];s&&(e[s.set]=1+(e[s.set]||0))}for(let s of Object.keys(e))t[M.settingName(s)]=e[s];return t}getFeatures(){let t=[],e=this.activeSets(),s=Object.keys(e);for(let i=0;i<s.length;++i){let r=s[i],n=DB.Artifacts.Sets.get(r);if(n){let s=n.getFeatures(e[r]);t=t.concat(s)}}return t}isBeta(){let t=this.activeSets(),e=Object.keys(t);for(let t of e){let e=DB.Artifacts.Sets.get(t);if(e&&e.isBeta())return!0}return!1}getStats(t){let e={stats:new a,settings:{}};for(let s=0;s<q.length;++s){const i=q[s];let r=this.artifacts[i];r&&e.stats.concat(r.calcStats(t))}return e}getConditions(){let t=[],e=this.activeSets(),s=Object.keys(e);for(let i=0;i<s.length;++i){let r=s[i],n=DB.Artifacts.Sets.get(r);if(n){let s=n.getConditions(e[r]);t=t.concat(s)}}return t}getPostEffects(){let t=[];for(let e of DB.Artifacts.Sets.getList()){let s=e.getPostEffects();t=t.concat(s)}return t}getMultipliers(){let t=[],e=this.activeSets();for(const[s,i]of Object.entries(e)){let e=DB.Artifacts.Sets.get(s);if(e){let s=e.getMultipliers(i);t=t.concat(s)}}return t}modifySets(t){let e=[].concat(t),s={},i=DB.Artifacts.Sets.getKeys();for(let t=0;t<q.length;++t){const r=q[t];let n=this.artifacts[r];if(n){let t=e.shift();if(!t)for(const e of i){if(s[e])continue;let i=DB.Artifacts.Sets.get(e);i.getConditions(1).length||i.minRarity<=n.rarity&&i.maxRarity>=n.rarity&&(t=e)}s[t]=1,n.set=t}}}set(t){let e=t.slot;this.artifacts[e]=t,this.removeInvalidSettings()}replace(t){for(let e of t){let t=e.slot;this.artifacts[t]=e}this.removeInvalidSettings()}remove(t){let e=t.getHash();for(let t=0;t<q.length;++t){const s=q[t];let i=this.artifacts[s];i&&i.getHash()==e&&(this.artifacts[s]=null,this.removeInvalidSettings())}}clearArtifacts(){for(let t=0;t<q.length;++t){const e=q[t];this.artifacts[e]=null}}isEquipped(t){let e=t.slot;return!(!this.artifacts[e]||this.artifacts[e]!=t)}activeSets(){let t={};for(let e=0;e<q.length;++e){const s=q[e];let i=this.artifacts[s];i&&(i.set&&(t[i.set]||(t[i.set]=0),++t[i.set]))}return t}serialize(t){let e=[],s=0;for(let t=0;t<q.length;++t){const i=q[t];let r=this.artifacts[i];r&&(++s,e=e.concat(r.serialize()))}e.unshift(s);let i=this.serializeConditions(t);return e.concat(i)}static deserialize(t){let e=t.shift();if(e<0||e>5)return null;let s=new U;for(let i=1;i<=e;++i){let e=M.deserialize(t);if(!e)return null;s.set(e)}let i=s.deserializeConditions(t);return i?(s.setSettings(i),s):null}}const G={atk:{serializeId:1,flat:!0},atk_percent:{serializeId:2},def:{serializeId:3,flat:!0},def_percent:{serializeId:4},hp:{serializeId:5,flat:!0},hp_percent:{serializeId:6},mastery:{serializeId:7,flat:!0},recharge:{serializeId:8},crit_rate:{serializeId:9},crit_dmg:{serializeId:10},healing:{serializeId:11},healing_recv:{serializeId:12},shield:{serializeId:13},recharge:{serializeId:14},crit_rate:{serializeId:15},crit_dmg:{serializeId:16},healing:{serializeId:17},healing_recv:{serializeId:18},shield:{serializeId:19},dmg_all:{serializeId:20},dmg_anemo:{serializeId:21},dmg_cryo:{serializeId:22},dmg_dendro:{serializeId:23},dmg_electro:{serializeId:24},dmg_geo:{serializeId:25},dmg_hydro:{serializeId:26},dmg_pyro:{serializeId:27},dmg_phys:{serializeId:28},dmg_normal:{serializeId:29},dmg_charged:{serializeId:30},dmg_plunge:{serializeId:31},dmg_skill:{serializeId:32},dmg_burst:{serializeId:33},enemy_def_reduce:{serializeId:34},enemy_def_ignore:{serializeId:35}};let W={};for(let t of Object.keys(G))W[G[t].serializeId]=t;class $ extends V{constructor(){super(),this.buffs=DB.Buffs,this.partyCharIds=[]}get(){return this.buffs}getFeatures(){return[]}isBeta(){return!1}getStats(t){return{stats:new a,settings:{}}}getConditions(t){let e=[];t||={};for(const t of this.buffs.getList())e=e.concat(t.getConditions());let s=this.getPartyChars();if(!t.serialize)for(let t=0;t<s.length;++t){let i=s[t];const r=DB.Chars.getById(i);r&&(e=e.concat(r.getPartyConditions()))}return e}getMultipliers(){let t=[];for(const e of this.buffs.getList())t=t.concat(e.getMultipliers());let e=this.getPartyChars();for(let s of e){const e=DB.Chars.getById(s);e&&(t=t.concat(e.getPartyMultipliers()))}return t}getPostEffects(){let t=[],e=this.getPartyChars();for(const e of this.buffs.getList())t=t.concat(e.getPostEffects());for(let s=0;s<e.length;++s){let i=e[s];const r=DB.Chars.getById(i);r&&(t=t.concat(r.getPartyPostEffects()))}return t}setPartyChars(t){this.partyCharIds=[];for(const e of t)e&&DB.Chars.getById(e)&&this.partyCharIds.push(e)}getPartyChars(){return[].concat(this.partyCharIds)}getSettings(){let t=super.getSettings(),e=1;for(let s=1;s<=3;++s){let i=this.partyCharIds[s-1];const r=DB.Chars.getById(i);r?(++e,t["party_char_"+s]=i,t["resonance_element_"+s]=r.getElement()):(t["party_char_"+s]=0,t["resonance_element_"+s]="")}return t.party_size=e,t}serialize(t){let e=this.serializeConditions(t);return[].concat(e)}serializeChars(t){let e=this.getPartyChars(),s=[],i=0;for(let r=0;r<e.length;++r){let n=e[r],a=DB.Chars.getById(n);if(a){++i;let e=a.getPartyConditions(),r=this.serializeConditions(t,e);s.push(n),s=s.concat(r)}}return s.unshift(i),s}serializeCustomBuffs(t){let e=0,s=[];for(let i of Object.keys(G)){let r=t["custom_buffs."+i];if(!r)continue;++e;let n=G[i];s.push(n.serializeId),n.flat?s.push(Math.floor(r)):s.push(Math.floor(10*r))}return e&&s.unshift(e),s}deserializeChars(t){let e=t.shift(),s={};for(let i=0;i<e;++i){let e=t.shift(),r=DB.Chars.getById(e);if(!r)return null;let n=r.getPartyConditions();s["party_char_"+(i+1)]=e;let a=this.deserializeConditions(t,n);s=Object.assign(s,a)}return s}deserializeCustomBuffs(t){let e=t.shift(),s={};for(let i=0;i<e;++i){let e=t.shift(),i=W[e];if(!i)return null;let r=G[i],n=t.shift();r.flat||(n/=10),s["custom_buffs."+i]=n}return s}static deserialize(t){let e=new $,s=e.deserializeConditions(t);if(!s)return null;let i={};e.partyCharIds=[];for(let t=1;t<=3;++t)s["party_char_"+t]&&e.partyCharIds.push(s["party_char_"+t]);if(0==e.partyCharIds.length)for(let t=1;t<=3;++t){let r=s["old_resonance_element_"+t];if(r){delete s["old_resonance_element_"+t];for(const t of DB.Chars.getList()){let s=t.getId();if(!i[s]&&r==t.getElement()){e.partyCharIds.push(s),i[s]=1;break}}}}return e.setSettings(s),e}}class K{constructor(t,e){this.stat=t,this.values=e}getName(){return this.stat}getValue(t){return t>0?(t>this.values.length&&(t=this.values.length),this.values[t-1]):0}getValues(){return this.values}multiply(t){let e=[];for(let s of this.values)e.push(s*t);return new K(this.stat,e)}}const J=new K("",[1,2,4,6,8,10]);class X extends V{constructor(){super(),this.levels={level:1,ascension:0,constellation:0},this.skills={attack:1,elemental:1,burst:1}}setLevels(t){this.levels.level=t.level,this.levels.ascension=t.ascension,this.levels.constellation=t.constellation}getLevels(){return{level:this.levels.level,ascension:this.levels.ascension,constellation:this.levels.constellation}}setSkills(t){this.skills.attack=t.attack,this.skills.elemental=t.elemental,this.skills.burst=t.burst}getId(){return this.object?this.object.getId():0}getName(){return this.object?this.object.getName():""}getSkills(){return{attack:this.skills.attack,elemental:this.skills.elemental,burst:this.skills.burst}}getConditions(){let t=super.getConditions();if(!this.object)return t;let e=this.object.constellation;return e&&(t=t.concat(e.getConditions(this.levels.constellation))),t=t.concat(DB.Conditions.Character),t}getFeatures(){let t=super.getFeatures();if(!this.object)return t;let e=this.getConstellation();return e&&(t=t.concat(e.getFeatures(this.levels.constellation))),t}getSettings(){let t=super.getSettings(),e=J.getValue(this.levels.ascension||1),s={char_skill_attack:Math.min(e,this.skills.attack),char_skill_elemental:Math.min(e,this.skills.elemental),char_skill_burst:Math.min(e,this.skills.burst),char_level:this.levels.level,char_ascension:this.levels.ascension,char_constellation:this.levels.constellation};return this.object&&(s.char_id=this.object.getId(),s.char_name=this.object.name,s.char_element=this.object.element,s.char_origin=this.object.origin),t=Object.assign(t,s),t}getConstellation(){return this.object.constellation}getElement(){return this.object&&this.object.getElement()||""}getWeaponType(){return this.object&&this.object.getWeapon()||""}serialize(t){let e=[];if(!this.object)return null;e.push(this.object.getId()),e.push(this.levels.level,this.levels.ascension,this.levels.constellation),e.push(this.skills.attack,this.skills.elemental,this.skills.burst);let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=DB.Chars.getById(t.shift());if(!e)return null;let s=t.shift();if(s<1||s>100)return null;let i=t.shift();if(i<0||i>6)return null;let r=t.shift();if(r<0||r>6)return null;let n=t.shift();if(n<1||n>10)return null;let a=t.shift();if(a<1||a>10)return null;let o=t.shift();if(o<1||o>10)return null;let l=new X;l.set(e),l.setLevels({level:s,ascension:i,constellation:r}),l.setSkills({attack:n,elemental:a,burst:o});let h=l.deserializeConditions(t);return h?(l.setSettings(h),l):null}}class Y extends V{constructor(){super(),this.levels={level:1},this.resistances={phys:0,anemo:0,cryo:0,geo:0,hydro:0,pyro:0,electro:0,dendro:0}}setLevels(t){this.levels.level=t.level}setResistances(t){for(const e of["anemo","cryo","dendro","electro","geo","hydro","phys","pyro"])this.resistances[e]=parseInt(t[e])||0}getResistances(){return this.object?this.object.getResistances():this.resistances}getStats(){return{stats:new a,settings:{}}}getSettings(){let t=super.getSettings(),e=this.getResistances();return t=Object.assign(t,{enemy_level:this.levels.level,enemy_res_phys:e.phys||0,enemy_res_anemo:e.anemo||0,enemy_res_cryo:e.cryo||0,enemy_res_geo:e.geo||0,enemy_res_hydro:e.hydro||0,enemy_res_pyro:e.pyro||0,enemy_res_electro:e.electro||0,enemy_res_dendro:e.dendro||0}),this.object&&(t.enemy_type=this.object.type,t=Object.assign(t,this.object.getSettings())),t}getConditions(){let t=super.getConditions();return t=t.concat(DB.Conditions.Enemy),t}serialize(t){let e=[];e.push(this.levels.level),this.object?(e.push(2),e.push(this.object.getId())):(e.push(1),e.push(this.resistances.anemo+100),e.push(this.resistances.cryo+100),e.push(this.resistances.dendro+100),e.push(this.resistances.electro+100),e.push(this.resistances.geo+100),e.push(this.resistances.hydro+100),e.push(this.resistances.phys+100),e.push(this.resistances.pyro+100));let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=t.shift();if(e<1||e>110)return null;let s=t.shift(),i=new Y;if(i.setLevels({level:e}),1==s){let e={};for(const s of["anemo","cryo","dendro","electro","geo","hydro","phys","pyro"]){let i=t.shift()-100;if(i<-100||i>1e3)return null;e[s]=i}i.setResistances(e)}else{if(2!=s)return null;{let e=DB.Enemies.getById(t.shift());if(!e)return null;i.set(e)}}let r=i.deserializeConditions(t);return r?(i.setSettings(r),i):null}}const Q=["Attack","Defence","Potion"];class Z extends V{constructor(){super(),this.food={Attack:{item:null,level:0},Defence:{item:null,level:0},Potion:{item:null,level:0}}}get(t){let e=this.food[t];if(e.item)return e.item}getLevel(t){let e=this.food[t];return e.item?e.level:0}set(t,e,s){this.food[t]={item:e,level:s}}isBeta(){return!1}getSettings(){return{}}getStats(t){let e={stats:new a,settings:{}};for(let t=0;t<Q.length;++t){const s=Q[t];let i=this.food[s];i.item&&e.stats.concat(i.item.getStats(i.level))}return e}getConditions(){return[]}getPostEffects(){return[]}serialize(){let t=[],e=0;for(let s=0;s<Q.length;++s){const i=Q[s];++e;let r=this.food[i];r.item?(t.push(r.item.getId()),t.push(r.level)):t.push(0)}return t.unshift(e),t}static deserialize(t){let e=new Z,s=t.shift();for(let i=0;i<s;++i){let s=Q[i];if(!s)return null;let r=t.shift(),n=0,a=DB.Food.get(s).getById(r);r>0&&(n=t.shift()),a&&(e.food[s]={item:a,level:n})}return e}}class tt extends V{isBeta(){return!1}getSettings(){return{}}getStats(t){return{stats:new a,settings:new T({})}}getConditions(){return[]}getFeatures(){return DB.Features.Reactions}getPostEffects(){return[]}}const et={1:"reaction.melt",2:"reaction.vaporize"};class st{constructor(t){this.name=t&&t.name||"",this.items=t&&t.items||[]}addItem(t){this.items.push(t)}getItems(){return this.items}getfeaturesNames(){let t=nt(this.items);return Object.keys(t)}getItem(t){return at(t,this.items)}replaceItem(t,e){let s=this.getItem(t);if(s){for(let t of Object.getOwnPropertyNames(s))"id"!=t&&delete s[t];for(let t of Object.getOwnPropertyNames(e))s[t]=e[t]}}deleteItem(t){let e=this.getItem(t);e&&ot(e,this.items)}clone(){return st.deserialize(this.serialize())}getHash(){return F.pack(this)}serialize(){let t=it(this.getItems());return t.unshift(0),t.unshift(3),t}static deserialize(t){let e=t.shift(),s=null;if(1==e||2==e||3==e){e>=2&&t.shift();let i=rt(t,0,e);s=new st({items:i})}return s}static getConditionData(t,e){let s={cond:null,typeId:0,icon:"",object:"",dbObject:null,invalid:!0},i=[],r=[];if("char"==t.subtype){let n=DB.Chars.getById(t.itemId);n&&(s.typeId=1,s.object="char",s.dbObject=n,s.icon="sprite-char "+n.getIcon(),i=n.getAllConditions(),e&&t.itemId==e.getChar().getId()&&(r=i))}else if("weapon"==t.subtype){let n=DB.Conditions.Weapon;i=i.concat(n);let a=DB.Weapons.getById(t.itemId);a&&(s.typeId=2,s.object="weapon",s.icon="sprite-weapon-"+a.weapon+" "+a.getIcon(),i=i.concat(a.getConditions()),e&&t.itemId==e.getWeapon().getId()&&(r=i))}else if("artifacts"==t.subtype){let n=DB.Artifacts.Sets.getById(t.itemId);n&&(s.typeId=3,s.object="artifacts",s.icon="sprite-artifact "+n.getImage()+" flower",i=n.getConditions(5),e&&(r=e.getConditions({objects:[t.subtype]})))}else if("enemy"==t.subtype){if(i=i.concat(DB.Conditions.Enemy),s.typeId=4,s.object="enemy",t.itemId){let e=DB.Enemies.getById(t.itemId);e&&(s.icon="sprite-enemy "+e.getImage(),i=i.concat(e.getConditions()),r=i)}}else if("party"==t.subtype){let n=DB.Chars.getById(t.itemId);if(n&&(s.typeId=5,s.object="buffs",s.icon="sprite-char "+n.getIcon(),i=H.unwrap(n.getPartyConditions()),e)){let s=e.getSettings();for(let e=1;e<=3;++e)s["party_char_"+e]==t.itemId&&(r=i)}}else if("buffs"==t.subtype){let e,n=[];for(const t of DB.Buffs.getList())n=n.concat(t.getConditions());for(let s of H.unwrap(n))if(s.getId()==t.conditionId){e=s;break}e&&(s.typeId=6,s.object="buffs",s.icon=e.getIcon(),i=[e],r=i)}for(const e of i)if(e.getId()==t.conditionId){s.cond=e;break}for(const e of r)if(e.getId()==t.conditionId){s.invalid=!1;break}return s}static getArtSetByCondition(t){for(const e of DB.Artifacts.Sets.getList())for(const s of e.getConditions(5))if(s.getId()==t)return e.getId();return 0}static getEnemyByCondition(t){for(const e of DB.Enemies.getList())for(const s of e.getConditions())if(s.getId()==t)return e.getId();return 0}}function it(t){let e=[],s=0;for(const i of t)if(i)if(e.push(i.disabled?1:0),e.push(i.collapsed?1:0),"feature"==i.type){let t=DB.Features.Rotation.getByName(i.feature);t&&(++s,e.push(1),e.push(t),e.push(Math.max(1,i.count)),e.push(i.reaction||0))}else if("condition"==i.type){let t=st.getConditionData(i);if(t.cond){let r;++s,e.push(2),e.push(t.typeId),e.push(i.itemId),e.push(t.cond.params.serializeId),r="decimal"==t.cond.params.format?Math.floor(10*parseFloat(i.value)):+i.value,e.push(r||0)}}else if("repeat"==i.type){++s,e.push(3),e.push(Math.max(1,i.count));let t=it(i.items);e=e.concat(t)}else if("uptime"==i.type){++s,e.push(4),e.push(1),e.push(Math.min(100,Math.max(0,i.percent)));let t=it([].concat(i.conditions,i.features));e=e.concat(t)}return e.unshift(s),e}function rt(t,e,s){let i=t.shift(),r=[];for(let n=0;n<i;++n){let i={disabled:!1};s>=2&&(i.disabled=!!t.shift()),s>=3&&(i.collapsed=!!t.shift());let n=t.shift();if(i.id=++e,1==n){i.type="feature";let e=t.shift();if(i.feature=DB.Features.Rotation.getById(e),!i.feature)return null;i.count=Math.max(1,t.shift()),i.reaction=t.shift()}else if(2==n){i.type="condition";let e=t.shift();if(1==e)i.subtype="char";else if(2==e)i.subtype="weapon";else if(3==e)i.subtype="artifacts";else if(4==e)i.subtype="enemy";else if(5==e)i.subtype="party";else{if(6!=e)return null;i.subtype="buffs"}i.itemId=t.shift(),i.conditionId=t.shift();let s=st.getConditionData(i),r=t.shift();s&&s.cond&&"decimal"==s.cond.params.format&&(r=a.format("text_decimal",r/10,{no_decimal_zero:!0})),i.value=r}else if(3==n)i.type="repeat",i.count=Math.max(1,t.shift()),i.items=rt(t,e,s),e+=i.items.length;else{if(4!=n)return null;{i.type="uptime",i.typeId=t.shift(),i.percent=Math.min(100,Math.max(0,t.shift())),i.conditions=[],i.features=[];let r=rt(t,e,s);e+=r.length;for(let t of r)"condition"==t.type?i.conditions.push(t):i.features.push(t)}}r.push(i)}return r}function nt(t){let e={};for(const s of t){"feature"==s.type&&(e[s.feature]=1);for(let t of["items","conditions","features"])if(s.hasOwnProperty(t)){let i=nt(s[t]);e=Object.assign(e,i)}}return e}function at(t,e){for(let s of e){if(s.id==t)return s;for(let e of["items","conditions","features"])if(s.hasOwnProperty(e)){let i=at(t,s[e]);if(i)return i}}return null}function ot(t,e){let s=e.indexOf(t);if(s>=0)return e.splice(s,1),1;for(let s of e)for(let e of["items","conditions","features"])if(s.hasOwnProperty(e)){if(ot(t,s[e]))return 1}return 0}class lt extends m{compile(t){return`Math.max(0, Math.min(1, ${super.compile(t)}))`}}class ht extends y{}class ct extends s{getType(){return"damage_result"}isCollapsable(){return!1}compile(t){return"["+this.compileChildrens(t).join(", ")+"]"}getSignature(){return null}}class ut extends S{getType(){return"damage_rotation_result"}makeResult(t){return t=Object.assign({},t),new i([...this.items,new ct(this.vars)])}}class ft{constructor(t){if(this.critChance=0,this.critMulti=1,t){let e=Object.keys(t);for(let s=0;s<e.length;++s){const i=e[s];this[i]=t[i]}}this.calcCritValues()}isHealing(){return this.icon&&"heal"==this.icon}calcCritValues(){void 0===this.average&&(this.normal?(this.crit=this.normal*this.critMulti,this.average=this.normal*(1-this.critChance)+this.crit*this.critChance):(this.normal=0,this.crit=0,this.average=0))}clone(){let t=Object.assign({},this);return Object.setPrototypeOf(t,ft.prototype),t}}class gt{constructor(t){this.name=t.name||(t.multipliers&&t.multipliers.length>0?t.multipliers[0].getName():""),this.isChild=t.isChild,this.hits=t.hits,this.icon=t.icon,this.tags=t.tags||[],this.multipliers=t.multipliers||[],this.category=t.category,this.condition=t.condition,this.element="",this.damageType="",this.rotationHitDescription=t.rotationHitDescription||"",this.rotationHitCount=t.rotationHitCount||1,this.critRateBonuses=t.critRateBonuses||[],this.critDamageBonuses=t.critDamageBonuses||[]}getDamageType(){return this.damageType}getElement(){return this.element}getName(){return this.category+"."+this.name}getIsChild(){return this.isChild}getHits(){return this.hits}getTags(){return this.tags}isRotation(){return!1}hasDetails(){return!1}canReact(){}usedInRotation(){return!1}isActive(t){return!this.condition||this.condition.isActive(t.settings)}compile(t){this.compiled=this.getCompiled(t)}getDisplaySettings(t){}getMultipliers(t){let e=[];for(let s of this.multipliers)s.isActive(t)&&e.push(s);for(let s of t.multipliers)s.isActive(t)&&s.isMatchFeature(this,t)&&e.push(s);return e}getActivePostEffectsTree(t){return t.getActivePostEffectsTree()}getCritRateBlock(t){let e=this.getStatsCritRate(t).map((e=>f(e,t.stats)));return 0==e.length&&(e=[new l({value:0})]),new lt(e)}getCritDmgBlock(t){let e=this.getStatsCritDamage(t).map((e=>f(e,t.stats)));return 0==e.length&&(e=[new l({value:0})]),new ht(e)}getCompiled(t,e){if(this.compiled)return this.compiled;e=Object.assign({dontProcessTree:1},e);let s=this.getTree(t),i=this.getActivePostEffectsTree(t),r=new A(s,i);return t.settings.reaction&&r.checkForReaction(),t.stats.ensure(r.usedStats),t.stats.ensure(r.assignedStats),r.prepare(t,e),r.compile(e),r}checkConditions(t){return!this.condition||this.condition.isActive(t.settings)}compile(t,e){let s=this.getTree(t);return this.compileTree(s,e)}compileTree(t,e){return e=Object.assign({},e),t.compile(e)}getResult(t){if(!this.checkConditions(t))return{};let e=this.getCompiled(t),[s,i,r]=e.execute(t);return{[this.getName()]:new ft({icon:this.icon||this.getElement(t),normal:s,crit:i,average:r,isReacted:e.isReacted,format:this.format,digits:this.digits,damageType:this.damageType,noCritValues:this.noCritValues})}}getUsedStats(e){let s=this.getTree(e),i=e.getActivePostEffectsTree(),r=new A(s,i);return e.stats.ensure(r.usedStats),r.prepare(e,{}),t(r.processed)}getRotationHitMiltiplier(t){return this.rotationHitCount}getDisplayRotationHitMiltiplier(t){return this.getRotationHitMiltiplier(t)}getRotationHitDescription(){return this.rotationHitDescription}static getTree(t){let e={};for(const s of Object.keys(t)){let i=s.split("."),r=i.shift(),n=i.join(".");void 0===e[r]&&(e[r]={}),e[r][n]=t[s]}return e}static buildDropdown(t,e){e=Object.assign({},e);let s=[],i=t.getFeaturesHash(t.getBuildData(),e),r=gt.getTree(i);for(let t of Object.keys(r)){s.push({isCaption:!0,value:"section_"+t,text:UI.Lang.get("feature_section."+t)});for(let e of Object.keys(r[t])){let i=r[t][e];if(i.hidden)continue;let n=t+"."+e,a="feature_"+n;i.title&&(a=i.title),a=UI.Lang.get(a),i.isChild&&(a=" "+a),s.push({value:n,text:a,isSubitem:!0,isChild:!!i.isChild})}}return s}}const pt=["","melt","vaporize","quicken"];class dt{constructor(t,e){t=[].concat(t),this.infoBlock,t.length>0&&"info"==t[0].type&&(this.infoBlock=t.shift()),this.items=t,this.opts=Object.assign({},e)}getTree(t,e){let[s,i,r,n]=this.processBlock(this.items,t,{usedStats:e});return new ut(s,{vars:[new u({ref:i}),new u({ref:r}),new u({ref:n})]})}processBlock(t,e,s){let i=new _([new l({value:0})],{name:"total_normal"}),r=new _([new l({value:0})],{name:"total_crit"}),n=new _([new l({value:0})],{name:"total_average"}),a=[i,r,n],o=e.clone(),h=o.settings?o.settings.rotation_include:"",c=[],f=[],g=[];t=function(t){let e=[],s=[];for(let i of t)"feature"==i.type?e.push(i):"condition"==i.type?(s&&(e=e.concat(s),s=[]),e.push(i)):("repeat"==i.type||"uptime"==i.type)&&s.push(i);s&&(e=e.concat(s));return e}(t),this.opts.ignoreSideEffects||(s=St(s));for(let e of t)if("feature"==e.type){o.settings.reaction=yt(e);let t=bt(e.feature,o);if(!t)continue;if(!t.usedInRotation())continue;if(h){let e=t.getElement(o),s=t.getDamageType();if(h!=e&&h!=s)continue}let a=t.getTree(o);_t(a,s);let f=[new l({value:e.count,comment:"rotation_hit_count"}),new S(a.items)],g=t.getRotationHitMiltiplier(o);"object"==typeof g?f.push(g):1!=g&&f.push(new l({value:g,comment:"rotation_hit_multi"}));let p=new _([new S(f)],{name:"normal"}),m=new _([a.critRate],{name:"crit_rate"}),y=new _([a.critDmg],{name:"crit_dmg"}),v=new _([new S([new u({ref:p}),new u({ref:y})])],{name:"crit_hit"}),w=[];a.royalCrit&&([w,m]=d(m,a.royalCrit)),w.length>0&&(c=c.concat(w)),c.push(p),c.push(m),c.push(y),c.push(v),c.push(new C([new u({ref:p})],{ref:i})),c.push(new C([new u({ref:v})],{ref:r})),c.push(new C([new S([new u({ref:p}),new b([new l({value:1}),new u({ref:m})])]),new S([new u({ref:v}),new u({ref:m})])],{ref:n}))}else if("condition"==e.type){if(c.length||f.length||g.length){let t=mt(c,f,g,s);t&&a.push(t),c=[],f=[],g=[]}for(let t of Object.keys(e.stats)){if(/^text_/.test(t))continue;let i={stat:t};if(s.copyStats){let e=vt(s,t),r=wt(t);i={stat:e,newName:r},s.stats[t]=r}f.push(new B([new l({value:e.stats.get(t)})],i))}s.usedStats&&e.stats.truncate(s.usedStats),o.addStats(e.stats),o.addSettings(e.settings);let t=s&&s.stats?Object.keys(s.stats):[];for(let i of e.postEffects)if(i.getTree)for(let e of i.getTree(o,s))t.includes(e.stat)&&(e.stat=s.stats[e.stat]),_t(e,s),g.push(e)}else if("repeat"==e.type){if(c.length||f.length||g.length){let t=mt(c,f,g,s);t&&a.push(t),c=[],f=[],g=[]}let[t,h,p,d]=this.processBlock(e.items,o,St(s));c.push(mt([...t,...[[h,i],[p,r],[d,n]].map((t=>{let[s,i]=t;return new C([new S([new l({value:e.count}),new u({ref:s})])],{ref:i})}))],[],[],s))}else if("uptime"==e.type){if(c.length||f.length||g.length){let t=mt(c,f,g,s);t&&a.push(t),c=[],f=[],g=[]}if(e.percent>0){let t=e.percent/100,[a,h,f,g]=this.processBlock([...e.conditions,...e.items],o,St(s));c.push(mt([...a,...[[h,i],[f,r],[g,n]].map((e=>{let[s,i]=e;return new C([new S([new l({value:t}),new u({ref:s})])],{ref:i})}))],[],[],s))}if(e.percent<100){let t=1-e.percent/100,[a,h,f,g]=this.processBlock(e.items,o,St(s));c.push(mt([...a,...[[h,i],[f,r],[g,n]].map((e=>{let[s,i]=e;return new C([new S([new l({value:t}),new u({ref:s})])],{ref:i})}))],[],[],s))}}if(c.length||f.length||g.length){let t=mt(c,f,g,s);t&&a.push(t)}return[a,i,r,n]}}function mt(e,s,i,r){if(0==e.length&&0==s.length)return null;let n=t(...e),a=e,o=A.filterPostByStats(i,n);if(o.length){let[t,e]=A.postTreeBlocks(o);a=[...t,new I(a),...e]}return s.length&&(a=[...s,...a]),new I(a)}function yt(t){return pt[t.reaction||0]}function bt(t,e){t=Array.isArray(t)?t:[t];for(let s of t)if(s.isActive(e)&&s.usedInRotation())return s}function St(t){let e=Object.assign({},t);if(e.stats={},e.copyStats=!0,t.stats)for(let s of Object.keys(t.stats))e.stats[s]=t.stats[s];return e}function vt(t,e){return t.stats&&t.stats[e]||e}function wt(t){return p(t)}function _t(t,e){if(e.stats){let s=Object.keys(e.stats);t.walk((t=>{if("item_stat_total"==t.getType())for(let i of[t.stat,t.stat+"_base",t.stat+"_percent"])s.includes(i)&&(t.replace||(t.replace={}),t.replace[i]=e.stats[i]);else t.stat&&s.includes(t.stat)&&(t.stat=e.stats[t.stat])}))}}class Ct extends gt{constructor(t){super(t),this.items=t.items}getName(){return"rotation.total"}getTree(t,e){return new dt(this.items,e).getTree(t)}compile(t,e){let s=this.getTree(t,e);return this.compileTree(s,e)}compileTree(t,e){return e=Object.assign({},e),t.compile(e)}getResult(t){if(!this.checkConditions(t))return{};let e=this.getCompiled(t),[s,i,r]=e.execute(t),n=this.getElement(t);return t.settings&&t.settings.rotation_include&&(n=t.settings.rotation_include),{[this.getName()]:new ft({icon:n,normal:s,crit:i,average:r})}}getResultForEditor(t){let e=t.getBuildData();return this.processBlock(this.items,e)}processBlock(t,e){let s=[];for(let i of t)if("feature"==i.type){e.settings.reaction=yt(i);let t=kt(i.feature,e);if(t){let r=t.getResult(e)[t.getName()];s.push({result:r,count:i.count,subLine:It(i.feature,e)})}else s.push({})}else if("condition"==i.type)i.settings&&e.addSettings(i.settings),i.stats&&e.addStats(i.stats),i.postEffects&&i.postEffects.length&&(e.postEffects=i.postEffects),i.multipliers&&i.multipliers.length&&(e.multipliers=i.multipliers);else if("repeat"==i.type){let t=e.clone();t.addSettings({inside_rotation_block:1});let r=this.processBlock(i.items,t);s=s.concat(r)}else if("uptime"==i.type){let t=e.clone();t.addSettings({inside_rotation_block:1});let r=t.clone(),n=this.processBlock(i.items,t),a=this.processBlock(i.conditions.concat(i.items),r),o=i.percent/100,l=1-o;for(let t=0;t<n.length;++t){let e=n[t].result,s=a[t].result;if(e||s){s?e||(n[t]=Object.assign({},a[t]),e=n[t].result={normal:0,crit:0,average:0}):s={normal:0,crit:0,average:0};for(let t of["normal","crit","average"])e[t]=e[t]*l+s[t]*o}}s=s.concat(n)}else"invalid"==i.type&&s.push({});return s}getDisplaySettings(t){let e={},s={},i=[{settings:{rotation_include:null},setTotal:1,icon:"multi"}];!function t(e,s,i,r){let n=s.clone();for(let s of e)if("feature"==s.type){let t=kt(s.feature,n);t&&(i[t.getElement(n)]=1,r[t.getDamageType()]=1)}else"condition"==s.type?(s.settings&&n.addSettings(s.settings),s.stats&&n.addStats(s.stats)):"repeat"==s.type?t(s.items,n,i,r):"uptime"==s.type&&(t(s.items,n,i,r),t([...s.conditions,...s.items],n,i,r))}(this.items,t,e,s);for(let t of Object.keys(e))i.push({id:"rotation.total_"+t,title:"rotation."+t,isChild:!0,settings:{rotation_include:t},getTotal:1});for(let t of Object.keys(s))i.push({id:"rotation.total_"+t,title:"rotation."+t,icon:"multi",isChild:!0,settings:{rotation_include:t},getTotal:1});return i}}function kt(t,e){t=Array.isArray(t)?t:[t];for(let s of t)if(s.isActive(e)&&s.usedInRotation())return s}function It(t,e){let s=kt(t,e),i=s.getRotationHitDescription(e);if(i)return{descr:"talent_descr."+i,value:s.getDisplayRotationHitMiltiplier(e)}}class Bt{constructor(t,e,s){this.build=t,this.rotation=e,this.opts=Object.assign({},s)}buildFeaturesList(){let t={},e=this.rotation.getfeaturesNames();for(let t of Object.keys(et))e.push(et[t]);for(let s of e){let e=this.build.getAllFeaturesByName(s,{ignoreRotation:!0});e.length&&(t[s]=e)}if(this.opts.loadArtifactsFeatures){let e=this.build.getBuildData();for(let s of DB.Artifacts.Sets.getList())for(let i of s.getFeatures(5)){let s=i.getResult(e.stats,e.settings);for(let e of Object.keys(s))t[e]=i}}return t}processConditions(t){if(0==this.conditions.length)return;let e=t.getBuildData(),s={},i=0;for(const r of this.conditions){let n,a={};if(r.static)a=r.getSettings(e.settings),n=r.object,++i;else{let e=st.getConditionData(r,t);if(!e.invalid&&e.cond&&e.cond.getName()&&Dt.includes(e.object)){++i,n=e.object;let t=e.cond.getType();a[e.cond.getName()]="dropdown"==t||"dropdown_multiple"==t?e.cond.getValueById(r.value):r.value}}n&&(s=Object.assign(s,a),t[n].addSettings(a),t.setCommonSettings(a))}if(this.conditions=[],!i)return;let r=t.getBuildData(),n=r.getActivePostEffects(),o=a.diff(e.stats,r.stats),l=function(t,e){let s={};for(let i of Object.keys(e))void 0!==t[i]&&t[i]==e[i]||(s[i]=e[i]);for(let i of Object.keys(t))void 0===e[i]&&(s[i]=void 0);return s}(e.settings,r.settings);return Object.keys(o).length||Object.keys(l).length||n.length?{type:"condition",stats:o,settings:l,postEffects:n}:void 0}processBlock(t,e,s){let i=[],r=[],n=e.filter((t=>!t.disabled));n.length&&"condition"!=n[0].type&&r.push({type:"condition",static:1,getSettings:()=>({})});for(const t of e)if(r.push(t),"feature"==t.type&&this.features[t.feature])for(let e of this.features[t.feature])if(e&&e.getRotationAfterItems){let i=e.getRotationAfterItems(t,{insideBlock:s});for(const t of i)r.push(t)}for(const e of r)if(!e.disabled){if("condition"!=e.type){let e=this.processConditions(t);e&&i.push(e)}if("feature"==e.type){let t=this.features[e.feature];if(t){++this.featuresTotal;let s={type:e.type,feature:t,featureName:e.feature,count:e.count,reaction:e.reaction};i.push(s)}else i.push({type:"invalid"})}else if("condition"==e.type)this.conditions.push(e);else if("repeat"==e.type){let s=this.processBlock(t,e.items,1);s&&i.push({type:e.type,count:e.count,items:s})}else if("uptime"==e.type){let s=this.processBlock(t,e.features,1);if(!s)continue;let r=this.processBlock(t,e.conditions,1);0==r.length?i.push({type:"repeat",count:1,items:s}):i.push({type:e.type,percent:e.percent,conditions:r,items:s})}}let a=this.processConditions(t);return a&&i.push(a),i}buildInfoBlock(){let t={type:"info"},e=0;if(this.sideEffectStats.length&&(e=1,t.sideEffectStats=this.sideEffectStats),e)return t}compile(){this.features=this.buildFeaturesList(),this.featuresTotal=0,this.conditions=[],this.sideEffectStats=[];let t=[].concat(this.rotation.getItems());t.unshift({type:"condition",static:1,getSettings:()=>({})});let e=this.processBlock(this.build.cloneWithArtifactSettings(),t);if(0==this.featuresTotal)return null;let s=this.buildInfoBlock();return s&&e.unshift(s),new Ct({name:this.rotation.name,items:e})}}class jt extends V{constructor(){super(),this.object=new st}set(t){this.object=t?t.clone():new st}isBeta(){return!1}getConditions(){return[]}getFeatures(){return[]}getPostEffects(){return[]}getSettings(){return[]}getMultipliers(){return[]}serialize(){return this.object.serialize()}static deserialize(t){if(0==t.length)return new jt;let e=st.deserialize(t),s=new jt;return s.set(e),s}}class At extends V{isBeta(){return!1}getSettings(){return{}}getStats(t){return{stats:new a,settings:new T({})}}getConditions(){return[]}getFeatures(){return DB.Features.Stats}getPostEffects(){return[]}}class zt extends V{constructor(){super(),this.levels={level:1,ascension:0,refine:1}}setLevels(t){this.levels.level=t.level,this.levels.ascension=t.ascension,this.levels.refine=Math.min(5,Math.max(1,t.refine))}getStats(){const t=super.getStats();if(this.object&&this.object.refineTable)for(let e of this.object.refineTable)t.stats.add(e.getName(),e.getValue(this.levels.refine));return t}getSettings(){let t=super.getSettings(),e={weapon_level:this.levels.level,weapon_ascension:this.levels.ascension,weapon_refine:this.levels.refine};return this.object&&(e.weapon_id=this.object.getId(),e.weapon_type=this.object.weapon),t=Object.assign(t,e),t}getId(){return this.object?this.object.getId():0}getName(){return this.object?this.object.getName():""}getConditions(){let t=super.getConditions();return t=t.concat(DB.Conditions.Weapon),t}serialize(t){let e=[];if(!this.object)return null;e.push(this.object.getId()),e.push(this.levels.level,this.levels.ascension,this.levels.refine);let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=DB.Weapons.getById(t.shift());if(!e)return null;let s=t.shift();if(s<1||s>90)return null;let i=t.shift();if(i<0||i>6)return null;let r=t.shift();if(r<0||r>5)return null;let n=new zt;n.set(e),n.setLevels({level:s,ascension:i,refine:r||1});let a=n.deserializeConditions(t);return a?(n.setSettings(a),n):null}}const Dt=["char","weapon","artifacts","enemy","buffs","rotation","food","reaction","static"],Ot=["char","weapon","artifacts","enemy","buffs","rotation","food"];class Tt{constructor(){this.char=new X,this.weapon=new zt,this.artifacts=new U,this.enemy=new Y,this.buffs=new $,this.rotation=new jt,this.food=new Z,this.reaction=new tt,this.static=new At}getChar(){return this.char}setChar(t){let e=this.getCommonSettings("char");this.char.set(t);let s="";this.weapon.object&&(s=this.weapon.object.weapon),s!=t.weapon&&this.setWeapon(DB.Weapons.get(t.weapon).getFirst());let i=this.buffs.getPartyChars();this.buffs.setPartyChars(i.filter((e=>e!=t.getId()))),this.setCharSettings(e)}setCharLevels(t){this.char.setLevels(t)}setCharSkills(t){this.char.setSkills(t)}setCharSettings(t){this.char.setSettings(t),this.setCommonSettings(t)}getWeapon(){return this.weapon}setWeapon(t){let e=this.getCommonSettings("weapon");this.weapon.set(t),this.setWeaponSettings(e)}setWeaponLevels(t){this.weapon.setLevels(t)}setWeaponSettings(t){this.weapon.setSettings(t),this.setCommonSettings(t)}setEnemy(t){this.enemy.set(t)}setEnemyLevels(t){this.enemy.setLevels(t)}setEnemyResistances(t){this.enemy.setResistances(t)}setEnemySettings(t){this.enemy.setSettings(t),this.setCommonSettings(t)}getEnemy(){return this.enemy}setArtifact(t){this.artifacts.set(t)}replaceArtifacts(t){this.artifacts.replace(t)}getArtifacts(){return this.artifacts.get()}getArtifactsHashList(){let t=[],e=this.getArtifacts();return Object.keys(e).forEach((function(s){let i=e[s];i&&t.push(i.getHash())})),t}removeArtifact(t){this.artifacts.remove(t)}clearArtifacts(){this.artifacts.clearArtifacts()}setArtifactsSettings(t){this.artifacts.setSettings(t),this.setCommonSettings(t)}isEquipped(t){return this.artifacts.isEquipped(t)}getBuffs(){return this.buffs.get()}setBuffsSettings(t){this.buffs.setSettings(t),this.setCommonSettings(t)}modifyBuffsSettings(t){let e=this.buffs.modifySettings(t);this.setCommonSettings(e)}setPartyChars(t){this.buffs.setPartyChars(t)}getPartyChars(){return this.buffs.getPartyChars()}setRotation(t){this.rotation.set(t)}getRotation(){return this.rotation.get()}setFood(t,e,s){return this.food.set(t,e,s)}getFood(t){return this.food.get(t)}getFoodLevel(t){return this.food.getLevel(t)}hasBetaContent(){for(let t of Dt)if(this[t]&&this[t].isBeta())return!0;return!1}refreshCommonSettings(){let t=this.getSettings();for(let e of Dt){if(!this[e])continue;let s=this[e].getSettings(),i=this.getActiveConditions(t,{objects:[e]});H.setCommonValues(s,i),this[e].setSettings(s)}}getCommonSettings(t){let e=this.getSettings(),s=this[t].getSettings();for(let t of Object.keys(e))/^common\./.test(t)&&(s[t]=e[t]);return s}setCommonSettings(t){let e=[];for(const s of Object.keys(t))/^common\./.test(s)&&e.push(s);if(0!=e.length)for(let s of Dt){if(!this[s])continue;let i=this[s].getSettings();for(const s of Object.keys(i))e.includes(s)&&(i[s]=t[s]);this[s].setSettings(i)}}getConditions(t){let e=[],s=Dt;for(let i=0;i<s.length;++i){let r=s[i];this[r]&&(t&&t.objects&&!t.objects.includes(r)||(e=e.concat(this[r].getConditions())))}return e}getActiveConditions(t,e){let s=[],i=Dt;for(let r=0;r<i.length;++r){let n=i[r];if(!this[n])continue;if(e&&e.objects&&!e.objects.includes(n))continue;let a=this[n].getConditions();for(let e=0;e<a.length;++e){const i=a[e];i.params.hideInactive&&!i.checkSubconditions(t)||s.push(i)}}return s}getArtifactsConditions(){return this.artifacts?this.artifacts.getConditions():[]}getSettings(){let t={},e=Dt;for(let s=0;s<e.length;++s){let i=e[s];this[i]&&(t=Object.assign(t,this[i].getSettings()))}return t}getBaseStats(t,e){let s=new x;t&&s.stats.concat(t),s.settings.concat(this.getSettings(),e);let i=Dt;for(let t=0;t<i.length;++t){let e=i[t];if(!this[e])continue;let r=this[e].getConditions();for(let t=0;t<r.length;++t){let e=r[t].getData(s.settings);s.stats.concat(e.stats),s.settings.concat(s.settings,e.settings)}}for(let t=0;t<i.length;++t){let e=i[t];if(!this[e])continue;let r=this[e].getStats(s.settings);s.stats.concat(r.stats),s.settings.concat(s.settings,r.settings)}return s.stats.get("dmg_own")&&s.stats.add("dmg_"+s.settings.char_element,s.stats.get("dmg_own")),s.multipliers=this.getMultipliers(),s.postEffects=this.getPostEffects(),s}getBaseStatsWithSets(t,e){let s=this.getBaseStats(t,e),i=this.getPostEffects();return s.stats.applyPostEffects(s.settings,i,O),s}getPostEffects(){let t=[],e=Dt;for(let s=0;s<e.length;++s){let i=e[s];this[i]&&(t=t.concat(this[i].getPostEffects()))}return t}getMultipliers(){let t=[];for(let e of Dt)this[e]&&(t=t.concat(this[e].getMultipliers()));return t=t.concat(DB.CalcData.Multipliers),t}getStats(t,e){return this.getBaseStats(t,e)}getBuildData(t,e){let s=this.getBaseStats(t,e);return s.stats.processPercent(),s}calcFeatures(t){let e=this.getBuildData();return this.getFeatures(e,t)}getFeaturesList(t){let e=[];t=Object.assign({},t);for(let s of Dt){if(!this[s])continue;let i;if("rotation"==s){if(!t.ignoreRotation){let t=this.compileRotation();t&&(i=[t])}}else i=this[s].getFeatures();i&&(e=e.concat(i))}return e}compileRotation(){return new Bt(this,this.getRotation()).compile()}getFeaturesHash(t,e){e=Object.assign({},e);let s={};for(let i of this.getFeaturesList())t&&!i.checkConditions(t)||e.checkCallback&&!e.checkCallback(i)||(s[i.getName()]=i);return s}getFeatures(t){let e={};for(let s of this.getFeaturesList())e=Object.assign(e,s.getResult(t));return e}getFeaturesNames(){let t={},e=this.getStats(),s=this.getFeaturesList();for(let i=0;i<s.length;++i){const r=s[i];Object.assign(t,r.getFeatureNamesHash(e.stats,e.settings))}return t}getFeatureResultByName(t){let e=this.getFeatureByName(t);if(!e)return;let s=this.getBuildData();return e.getResult(s)[t]}getFeatureByName(t,e){if(!t)return null;e||=this.getBuildData();for(let s of this.getFeaturesList())if(s.isActive(e)&&t==s.getName())return s;return null}getAllFeaturesByName(t,e){if(!t)return[];let s=[];for(let i of this.getFeaturesList(e))t==i.getName()&&s.push(i);return s}clone(){return Tt.deserialize(this.serialize())}cloneWithArtifactSettings(){let t=Tt.deserialize(this.serialize());return t.artifacts.modifySettings(this.artifacts.getSettings()),t}getHash(){return F.pack(this)}serialize(){let t=[1],e=this.getSettings();for(let t of Dt)if(this[t])for(let s of this[t].getConditions()){let t=s.getData(e);Object.assign(e,t.settings)}for(let s of Ot){if(!this[s])return null;let i=this[s].serialize(e);if(!i)return null;t=t.concat(i)}return t}static deserialize(t){let e=null;if(1==t.shift()){if(e=new Tt,e.char=X.deserialize(t),!e.char)return null;if(e.weapon=zt.deserialize(t),!e.weapon)return null;if(e.artifacts=U.deserialize(t),!e.artifacts)return null;if(e.enemy=Y.deserialize(t),!e.enemy)return null;if(e.buffs=$.deserialize(t),!e.buffs)return null;if(e.rotation=jt.deserialize(t),!e.rotation)return null;if(e.food=Z.deserialize(t),!e.food)return null}return e}}class Et{constructor(t){this.keyName=t,this.items=[],this.reload()}list(){return this.items}listDecoded(t){let e=[];for(let s in this.items){let i=this.items[s],r=this.decodeItem(i.data);if(r){if(!t&&r.hasBetaContent&&r.hasBetaContent())continue;let n=Object.assign({},i);n.data=r,n.index=s,n.hash=i.data,e.push(n)}}return e}remove(t){if(!this.error&&void 0!==t&&this.items[t]){this.items.splice(t,1).length&&this.save()}}replace(t,e){if(this.error)return null;this.items[t]&&(this.items[t].data=F.pack(e),this.save())}get(t){let e=this.items[t];return e&&e.data?e:null}getItem(t){let e=this.items[t];return e&&e.data?this.decodeItem(e.data):null}setTitle(t,e){if(this.error)return null;this.items[t]&&(this.items[t].title=e,this.save())}add(t,e){if(this.error)return null;let s=Object.assign({},e);return s?(s.data=F.pack(t),delete s.hash,s.data?(this.items.push(s),void this.save()):null):null}save(){if(this.error)return null;let t=function(t){let e;try{e=JSON.stringify(t)}catch(t){console.log(t)}return e}(this.items);if(!t)return null;localStorage.setItem(this.keyName,t)}clear(){let t=this.items;return this.items=[],this.save(),t}restore(t){this.items=t}reload(){let t=this.getString();if(this.items=[],t){let e=this.parseString(t);if(!e)return void(this.error=!0);if(Array.isArray(e))for(let t of e){let e=this.validateItem(t);e&&this.items.push(e)}}}validateItem(t){return t}getString(){return this.keyName?localStorage.getItem(this.keyName):""}parseString(t){return function(t){let e;try{e=JSON.parse(t)}catch(t){console.log(t)}return e}(t)}itemHash(t){return t.data}fromBackup(t,e){if(!Array.isArray(t))return;let s=this.items,i={};try{if(e)for(const t of this.list())i[this.itemHash(t)]=1;else this.items=[];for(const e of t){if(i[e.data])continue;let t=this.decodeItem(e.data);if(t){i[this.itemHash(e)]=1;let s=Object.assign({},e);delete s.data,this.add(t,s)}}this.save()}catch{this.items=s}}}class xt extends Et{constructor(){super("artifact_pool"),this.resetCache()}decodeItem(t){let e=F.unpack(t);return e?M.deserialize(e):null}fromPool(t){this.items=[],this.error=!1;for(let e of t.items)this.items.push({data:F.pack(e),locked:e.isLocked(),group:e.getGroups()});this.save()}validateItem(t){return this.decodeItem(t.data)?xt.getValidData(t):null}parseString(t){if("["==t.substring(0,1))return super.parseString(t);let e=t.split(";"),s=[];for(let t of e)s.push({data:t,locked:0,group:""});return s}storageHashes(){let t={};for(let e of this.listDecoded(1))t[e.data.getHash()]=1;return t}listGroups(){return this.requireCache(),this.groupsCache}listArtifacts(){return this.requireCache(),this.artifactsCache}save(){super.save(),this.resetCache()}reload(){super.reload(),this.resetCache()}getByHash(t){this.requireCache();let e=this.indexByHash[t];return this.artifactsCache[e]}getItemByHash(t){this.requireCache();let e=this.indexByHash[t];return this.items[e]}getArtByIndex(t){return this.requireCache(),this.artifactsCache[t]}addArtifacts(t,e){this.requireCache();let s=[];for(let i of t){let t=i.getHash();!e&&this.indexByHash[t]||s.push({data:t,locked:i.isLocked(),group:i.getGroups()})}s.length&&(this.items=e?s:this.items.concat(s),this.save())}updateByHash(t,e){let s=this.getItemByHash(t);s&&(s.data=F.pack(e),s.locked=e.isLocked(),s.group=e.getGroups(),this.save())}updateGroup(t,e){for(let s of this.items){let i=[];for(let r of s.group)M.groupsAreEqual(r,t)?i.push(e):i.push(r);s.group=i}this.save()}deleteByHash(t){this.requireCache(),this.remove(this.indexByHash[t])}getLocked(){let t=[];for(let e of this.items)e.locked&&t.push(e.data);return t}requireCache(){null===this.artifactsCache&&this.refreshCache()}resetCache(){this.artifactsCache=null,this.groupsCache=null,this.indexByHash=null}refreshCache(){this.artifactsCache=[],this.groupsCache=[],this.indexByHash={};let t={},e={"":0};for(let s in this.items){let i=this.items[s];this.indexByHash[i.data]=s;for(let s of i.group)if(s){let i=s.toUpperCase();t[i]=s,e[i]||(e[i]=0),++e[i]}else++e[""];let r=this.decodeItem(i.data);r.setLocked(i.locked),r.setGroups(i.group),this.artifactsCache.push(r)}this.groupsCache=[{value:"",title:UI.Lang.get("artifact_group.empty_group"),count:e[""]}];for(let s of Object.keys(t).sort())this.groupsCache.push({value:t[s],title:t[s],count:e[s]})}getSimilar(t){let e=[];if(!t||!t.set||!t.mainStat)return[];for(let s in this.artifactsCache){const i=this.artifactsCache[s];t.set!=i.set||t.mainStat!=i.mainStat||t.rarity!=i.rarity||t.level<i.level||M.subStatsIsSimilar(t,i)&&e.push({art:i,index:s})}return e}setLocked(t,e){let s={};for(let e of t)s[e]=1;for(let t of this.items)s[t.data]&&(t.locked=!!e);this.save()}lockAll(){for(let t of this.items)t.locked=1;this.save()}unlockAll(){for(let t of this.items)t.locked=0;this.save()}static getValidData(t){return{data:t.data,locked:!!t.locked,group:M.trimGroupNames(t.group)}}}class Ft{constructor(t){this.data=t}setLastModified(t){this.data.lastModified=t}getLastModified(){return this.data.lastModified||0}getChars(){return this.data.chars||[]}getArtifacts(){return this.data.artifacts||[]}getRotations(){return this.data.rotations||[]}stringify(){return JSON.stringify(this.data)}toBlob(){return new Blob([this.stringify()],{type:"application/json;charset=utf-8"})}static fromStorage(t,e){e||(e={saveChars:1,saveArts:1,saveRotations:1});let s={version:1};if(e.saveChars){let e=t.char.list();s.chars=[];for(let i in e){let r=e[i];t.char.decodeItem(r.data)&&s.chars.push(r)}}if(e.saveArts){let e=t.artifacts.list();s.artifacts=[];for(let t of e)s.artifacts.push(t)}if(e.saveRotations){let e=t.rotation.list();s.rotations=[];for(let i in e){let r=e[i];t.rotation.decodeItem(r.data)&&s.rotations.push(r)}}return new Ft(s)}static fromString(t){let e;try{e=JSON.parse(t)}catch(t){return null}if("object"!=typeof e)return null;let s={};if(1!=e.version)return null;if(s.version=1,s.lastModified=parseInt(e.lastModified),e.chars&&Array.isArray(e.chars)){let t=[];for(const s of e.chars){if("object"!=typeof s)return null;Tt.deserialize(F.unpack(s.data))&&t.push({title:""+(s.title||""),data:s.data})}t.length&&(s.chars=t)}if(e.artifacts&&Array.isArray(e.artifacts)){let t=[];for(const s of e.artifacts){if("object"!=typeof s)return null;let e=xt.getValidData(s);e&&t.push(e)}t.length&&(s.artifacts=t)}if(e.rotations&&Array.isArray(e.rotations)){let t=[];for(const s of e.rotations){if("object"!=typeof s)return null;st.deserialize(F.unpack(s.data))&&t.push({title:""+(s.title||""),icon:s.icon,data:s.data})}t.length&&(s.rotations=t)}return new Ft(s)}}class Lt extends Et{constructor(){super("char")}decodeItem(t){let e=F.unpack(t);return e?Tt.deserialize(e):null}itemHash(t){return t.data+"-"+(t.title||"")}savedHashes(){let t={};for(let e of this.listDecoded(1)){let s=e.data.getChar().object;for(const[i,r]of Object.entries(e.data.getArtifacts()))if(r){let e=r.getHash();t[e]||(t[e]=[]);let i=s.getIcon();t[e].includes(i)||t[e].push(i)}}return t}addChars(t){let e={};for(let t of this.items)e[t.data]=1;for(let s of t){let t=s.set,i=t.getHash();i&&!e[i]&&this.add(t,{})}}}class Pt extends Et{constructor(){super("rotation"),this.resetCache()}decodeItem(t){let e=F.unpack(t);return e?st.deserialize(e):null}itemHash(t){return t.data+"-"+(t.title||"")}setIcon(t,e){if(this.error)return null;this.items[t]&&(this.items[t].icon=e,this.save())}getByHash(t){this.requireCache();let e=this.indexByHash[t];return this.itemsCache[e]}getItemByHash(t){this.requireCache();let e=this.indexByHash[t];return this.items[e]}getByIndex(t){return this.requireCache(),this.itemsCache[t]}deleteByHash(t){this.requireCache(),this.remove(this.indexByHash[t])}updateByHash(t,e){this.requireCache();let s=this.getItemByHash(t);s&&(s.data=F.pack(e),this.save())}updateTitleByHash(t,e){this.requireCache();let s=this.getItemByHash(t);s&&(s.title=e,this.save())}updateIconByHash(t,e){this.requireCache();let s=this.getItemByHash(t);s&&(s.icon=e,this.save())}requireCache(){null===this.itemsCache&&this.refreshCache()}save(){super.save(),this.resetCache()}reload(){super.reload(),this.resetCache()}resetCache(){this.itemsCache=null,this.indexByHash=null}refreshCache(){this.itemsCache=[],this.indexByHash={};for(let t in this.items){let e=this.items[t];this.indexByHash[e.data]=t;let s=this.decodeItem(e.data);this.itemsCache.push({icon:e.icon,title:e.title,item:s,hash:e.data})}}}class Rt extends Et{constructor(){super("settings")}remove(t){delete this.items[t],this.save()}get(t){let e=this.items[t];return void 0===e&&(e=this.getDefaultValue(t)),e}showBetaContent(){return!!this.get("show_beta_content")}getDefaultValue(t){return t.match(/_arr$/)?[]:""}set(t,e){let s=this.validateItem(t,e);s&&(this.items=Object.assign(this.items,s),this.save())}reload(){let t=this.getString();if(this.items={},t){let e=this.parseString(t);if(!e)return;if("object"==typeof e&&!Array.isArray(e)&&null!==e)for(let t of Object.keys(e)){let s=this.validateItem(t,e[t]);s&&Object.assign(this.items,s)}}}validateItem(t,e){let s={};if(t.match(/_arr$/)){if(!Array.isArray(e))return;{let i=[];for(let t of e)"string"!=typeof t&&"number"!=typeof t||i.push(t);s[t]=i}}else{if("string"!=typeof e&&"number"!=typeof e)return;s[t]=e}return s}}const Nt="AIzaSyBiK_Y9LXJMzYxGt_p2qJ2dnMGtxOXHoU8",Mt="https://www.googleapis.com/auth/drive.appdata",Ht="https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";class Vt{init(t,e,s){if(this.client)s?t():this.requestLogin(e);else{let i={client_id:"23514418281-hnsnrvdaiu6loi8rob1ttuned773n7iq.apps.googleusercontent.com",scope:Mt,callback:e=>{this.setToken(e),t()}};e||(i.prompt=""),gapi.load("client",(()=>{this.client=google.accounts.oauth2.initTokenClient(i),gapi.client.setApiKey(Nt),gapi.client.load(Ht).then((()=>{s?(this.setToken(s),t()):this.requestLogin(e)}))}))}}setToken(t){t&&t.access_token&&(this.response=t,gapi.client.setToken(t))}checkLogin(t,e){t&&t.access_token&&(this.response=t,gapi.client.setApiKey(Nt),gapi.client.setToken(t),gapi.client.load(Ht).then((()=>{this.isLogged()&&e()})))}isLogged(){return!!this.hasAccess()}hasAccess(){return google.accounts.oauth2.hasGrantedAnyScope(this.response,Mt)}requestLogin(t,e){this.response=null,t?this.client.requestAccessToken({prompt:"select_account"}):this.client.requestAccessToken({prompt:"",hint:e})}revoke(){this.response&&(this.response=void 0,google.accounts.oauth2.revoke(this.response.access_token))}async getFileId(t,e){let s,i=await gapi.client.drive.files.list({spaces:"appDataFolder"});for(let e of i.result.files)e.name!=t||s?this.delete(e.id):s=e.id;if(!s&&!e){let e=await gapi.client.drive.files.create({name:t,mimeType:"application/json",parents:["appDataFolder"]});e&&e.result&&(s=e.result.id)}return s}async download(t){return(await gapi.client.drive.files.get({fileId:t,alt:"media"})).body}async upload(t,e){return(await gapi.client.request({path:`/upload/drive/v3/files/${t}`,method:"PATCH",params:{uploadType:"media"},body:e})).result.id}async delete(t){await gapi.client.drive.files.delete({fileId:t})}isGapiLoaded(){return gapi&&gapi.auth2}logout(){this.isGapiLoaded()&&gapi.auth2.getAuthInstance().signOut()}}class qt{constructor(t){this.app=t,this.api=new Vt,this.scripts={"https://apis.google.com/js/api.js":!1,"https://accounts.google.com/gsi/client":!1}}init(){for(let t of Object.keys(this.scripts)){const e=document.createElement("script");e.onload=()=>{this.scriptLoaded(t)},e.onerror=()=>{this.scriptError(t)},document.head.appendChild(e),e.src=t}}isEnabled(){return this.app.getSetting("storage_sync_enabled")}scriptLoaded(t){this.scripts[t]=!0,this.isScriptsLoaded()&&this.apiLoaded()}scriptError(t){this.isEnabled()&&(UI.Sync.enable(),this.setError("load_failed"))}isScriptsLoaded(){let t=!0;for(let e of Object.keys(this.scripts))t&&=this.scripts[e];return t}apiLoaded(){this.setStatus("disabled"),this.isEnabled()&&(UI.Sync.enable(),this.driveInitApp())}driveInitApp(t){this.setStatus(t?"auth":"init"),this.api.init((()=>{this.apiIsLoaded()}),t,t?"":this.getSavedToken())}getSavedToken(){try{let t=JSON.parse(this.app.getSetting("token_response"));if(t.access_token)return t}catch{}}saveToken(){let t=this.api.response;t?this.app.setSetting("token_response",JSON.stringify(t)):this.app.setSetting("token_response","")}apiIsLoaded(){this.api.isLogged()?(this.authFail=0,this.app.setSetting("storage_sync_enabled",1),this.app.refresh(),this.saveToken(),this.storageSync()):this.setError("not_logged")}setStatus(t){UI.Sync.setStatus(t)}setError(t){this.setStatus("error")}async backupFileId(t){let e=this.app.getSetting("storage_backup_file");return e||(e=await this.api.getFileId("backup.json",t)),e}async storageSync(){this.setStatus("check");try{let t=await this.backupFileId(),e=await this.api.download(t),s=Ft.fromString(e),i=this.app.getSetting("storage_last_modified")||0,r=s?s.getLastModified():0;i>r?this.storageSyncUpload():i<r?this.storageSyncDownload(s):this.setStatus("ok")}catch(t){this.processError(t)}}async storageSyncUpload(){this.setStatus("sync");try{let t=await this.backupFileId(),e=this.app.storage.createBackup();await this.api.upload(t,e.stringify())}catch(t){this.processError(t)}this.setStatus("ok")}async storageSyncDownload(t){this.setStatus("sync"),this.app.storage.loadBackup(t),this.setStatus("ok"),this.app.refresh()}async deleteBackupFiles(){try{let t=await this.backupFileId(!0);await this.api.delete(t)}catch(t){}}processError(t){if(this.app.setSetting("storage_sync_enabled",0),401==t.status)return this.authFail?void this.setError("unknown"):(this.setStatus("auth"),this.authFail=1,void this.api.requestLogin(!1,this.app.getSetting("storage_hint_email")));this.setError("unknown")}async disable(t){this.app.setSetting("storage_sync_enabled",0),this.app.setSetting("token_response",""),t&&(await this.deleteBackupFiles(),this.api.revoke(),this.saveToken()),UI.Sync.disable()}queue(){this.setStatus("pending"),this.app.setSetting("storage_last_modified",Date.now()),this.syncTimeout&&clearTimeout(this.syncTimeout),this.syncTimeout=setTimeout((()=>{this.storageSyncUpload()}),1e4)}}class Ut{constructor(t){this.app=t,this.char=new Lt,this.rotation=new Pt,this.artifacts=new xt,this.settings=new Rt,this.sync=new qt(t)}createBackup(t){let e=Ft.fromStorage(this,t);return e.setLastModified(this.app.getSetting("storage_last_modified")||Date.now()),e}loadBackup(t,e){if(!t)return;e=Object.assign({},e),this.char.fromBackup(t.getChars(),e.addChars),this.rotation.fromBackup(t.getRotations(),e.addRotations);let s=t.getArtifacts();if(s){let t=this.app.storage.artifacts;e.addArts||t.clear();let i=[];for(const t of s){let e=M.deserialize(F.unpack(t.data));e&&(e.setLocked(t.locked),e.setGroups(t.group),i.push(e))}t.addArtifacts(i),this.app.refresh()}return 1}}class Gt{constructor(t){this.version=t,this.storage=new Ut(this),this.settings={},this.current=new Tt,this.loadDefault(),window.addEventListener("hashchange",(()=>{this.checkHash()}))}loadDefault(){let t=DB.Chars.getFirst();this.current.setChar(t),this.current.setWeapon(DB.Weapons.get(t.weapon).getFirst()),this.current.setEnemy(DB.Enemies.getFirst().getFirst())}checkHash(){let t,e=document.location.hash||"";if(e=e.substring(1),/^r/.exec(e)){let s=F.unpack(e.substring(1));t=st.deserialize(s)}else{let t=/^uid(\d{9})$/.exec(e);t&&UI.EnkaImport.show(t[1]),t=/^profile_(\w+)$/.exec(e),t&&UI.EnkaImport.show(t[1])}let s=!1;if(e){let t=F.unpack(e);if(t){let e=Tt.deserialize(t);if(e){e.hasBetaContent()&&!this.showBetaContent()||(s=!0,this.replaceSet(e))}}}if(!s){let t=F.unpack(this.getSetting("last_build"));if(t){let e=Tt.deserialize(t);if(e){e.hasBetaContent()&&!this.showBetaContent()||this.replaceSet(e)}}}t&&(this.setRotation(t),setTimeout((()=>{UI.Layout.showTab("rotation")}),500))}getVersion(){return this.version}resetBuild(t){let e;this.current=new Tt,t&&(e=DB.Chars.getById(t)),e||(e=DB.Chars.getFirst()),this.setChar(e),this.setWeapon(DB.Weapons.get(e.weapon).getFirst()),this.setEnemy(DB.Enemies.getFirst().getFirst()),document.location.hash=""}replaceSet(t){this.current=t,this.refresh()}currentSet(){return this.current}getFeatures(t){return this.currentSet().getFeatures(t,1)}setChar(t){this.currentSet().setChar(t),this.refresh()}setCharLevels(t){this.currentSet().setCharLevels(t),this.refresh()}setCharSkills(t){this.currentSet().setCharSkills(t),this.refresh()}setCharSettings(t){this.currentSet().setCharSettings(t),this.refresh()}getChar(){return this.currentSet().getChar()}setWeapon(t){this.currentSet().setWeapon(t),this.refresh()}setWeaponLevels(t){this.currentSet().setWeaponLevels(t),this.refresh()}setWeaponSettings(t){this.currentSet().setWeaponSettings(t),this.refresh()}setArtifact(t,e){this.currentSet().setArtifact(t),e||this.refresh()}getWeapon(){return this.currentSet().getWeapon()}setEnemy(t){this.currentSet().setEnemy(t),this.refresh()}setEnemyLevels(t){this.currentSet().setEnemyLevels(t),this.refresh()}setEnemyResistances(t){this.currentSet().setEnemyResistances(t),this.refresh()}setEnemySettings(t){this.currentSet().setEnemySettings(t),this.refresh()}getEnemy(){return this.currentSet().getEnemy()}getArtifacts(){return this.currentSet().getArtifacts()}removeArtifact(t){this.currentSet().removeArtifact(t),this.refresh()}setArtifactsSettings(t){this.currentSet().setArtifactsSettings(t),this.refresh()}isEquipped(t){return this.currentSet().isEquipped(t)}setFood(t,e,s){this.currentSet().setFood(t,e,s),this.refresh()}getFood(t){return this.currentSet().getFood(t)}getFoodLevel(t){return this.currentSet().getFoodLevel(t)}getBuffs(){return this.currentSet().getBuffs()}setBuffsSettings(t){this.currentSet().setBuffsSettings(t),this.refresh()}modifyBuffsSettings(t){this.currentSet().modifyBuffsSettings(t),this.refresh()}setRotation(t){this.currentSet().setRotation(t)}getRotation(){return this.currentSet().getRotation()}getSettings(){return this.currentSet().getSettings()}getConditions(t){return this.currentSet().getConditions(t)}getStats(){return this.currentSet().getStats()}setPartyChars(t){this.currentSet().setPartyChars(t),this.refresh()}getPartyChars(){return this.currentSet().getPartyChars()}setSetting(t,e){return this.storage.settings.set(t,e)}showBetaContent(){return this.storage.settings.showBetaContent()}getSetting(t){return this.storage.settings.get(t)}setFeature(t){this.setSetting("suggester_feature_name",t)}getFeature(){let t=this.currentSet().calcFeatures(1),e=Object.keys(t),s=this.getSetting("suggester_feature_name");return e.includes(s)||(s=e[0]),s}getDisplayMode(){return this.getSetting("suggester_display_mode")||"percent"}setDisplayMode(t){this.setSetting("suggester_display_mode",t)}queueUpdate(){this.getSetting("storage_sync_enabled")&&this.storage.sync.queue()}initSync(t){this.storage.sync.init(t)}enableSync(){UI.Sync.enable(),this.storage.sync.driveInitApp(!0)}disableSync(t){this.storage.sync.disable(t),this.refresh()}refresh(t){t=Object.assign({},t),this.currentSet().refreshCommonSettings(),this.saveLastBuild();let e=!1;if(Array.isArray(t.objects))for(let s of t.objects){if("storage"==s.split(".")[0]){e=!0;break}}e&&this.queueUpdate(),UI.Layout.refresh()}saveLastBuild(){let t=F.pack(this.currentSet());"bbbaabbbabbabaaabcbabrabadaaa"!=t?this.setSetting("last_build",t):this.setSetting("last_build","")}addCharactersToStorage(t){this.storage.char.addChars(t),this.refresh({objects:["storage.artifacts"]})}addArtifactsToStorage(t){this.storage.artifacts.addArtifacts(t),this.refresh({objects:["storage.artifacts"]})}}document.addEventListener("DOMContentLoaded",(function(){let t=new Gt("3.1.3b");UI.Layout.init(t),UI.Layout.refresh(),t.checkHash(),t.refresh(),t.initSync()}))})();